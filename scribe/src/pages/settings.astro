---
import Layout from '../layouts/Layout.astro';
import Icon from '../components/Icon.astro';
import { getTheme, themeList } from '../lib/themes';
import { getHeaderFont, getBodyFont, getMonoFont, headerFontList, bodyFontList, monoFontList } from '../lib/fonts';

const GARDENER_URL =
  process.env.GARDENER_URL ||
  import.meta.env.GARDENER_URL ||
  'http://localhost:8000';
const AUTH_TOKEN =
  process.env.ATHENA_AUTH_TOKEN ||
  import.meta.env.ATHENA_AUTH_TOKEN ||
  '';
const authHeaders = AUTH_TOKEN
  ? { Authorization: `Bearer ${AUTH_TOKEN}`, 'X-Auth-Token': AUTH_TOKEN }
  : {};

const defaultBranding = {
  app_name: 'Athena Scribe',
  icon_version: 'default',
  theme: 'default',
  font_header: 'inter',
  font_body: 'inter',
  font_mono: 'fira-code',
  has_icon: false,
};

let branding = { ...defaultBranding };
try {
  const response = await fetch(`${GARDENER_URL}/api/branding`, {
    headers: authHeaders,
  });
  if (response.ok) {
    branding = { ...branding, ...(await response.json()) };
  }
} catch (error) {
  console.warn('Failed to load branding settings', error);
}

const iconQuery = branding.icon_version ? `?v=${branding.icon_version}` : '';
const currentTheme = getTheme(branding.theme);
const currentHeaderFont = getHeaderFont(branding.font_header);
const currentBodyFont = getBodyFont(branding.font_body);
const currentMonoFont = getMonoFont(branding.font_mono);
---

<Layout title="Athena - Settings">
  <main class="min-h-screen p-4 md:p-8">
    <div class="max-w-3xl mx-auto">
      <div style="display: flex; flex-direction: column; gap: var(--spacing-section);">
      <header class="page-header">
        <h1 class="page-title">Settings</h1>
        <nav class="page-nav">
          <a href="/" class="nav-link">Capture</a>
          <a href="/browse" class="nav-link">Browse</a>
          <a href="/archive" class="nav-link">Archive</a>
        </nav>
      </header>

      <section class="panel" style="padding: var(--spacing-card); display: flex; flex-direction: column; gap: var(--spacing-element);">
        <div>
          <h2 class="text-lg text-primary" style="font-weight: var(--font-weight-semibold); margin-bottom: 0.5rem;">App branding</h2>
          <p class="text-sm text-subtle">
            Update the app name shown in the home screen shortcut and install banner.
          </p>
        </div>

        <form
          hx-post="/api/branding"
          hx-target="#branding-feedback"
          hx-swap="innerHTML"
          class="space-y-6"
        >
          <label class="block text-sm text-muted">
            App name
            <input
              type="text"
              name="app_name"
              value={branding.app_name}
              class="mt-2 w-full rounded-md px-3 py-2 input-field"
            />
          </label>

          <fieldset class="space-y-3">
            <legend class="text-sm text-muted">Theme</legend>
            <div class="grid gap-3 sm:grid-cols-2">
              {themeList.map((theme) => {
                const selected = currentTheme.id === theme.id;
                const swatches = [theme.colors.accentRgb, ...theme.categories.slice(0, 2)];
                return (
                  <label class={`theme-option ${selected ? 'theme-option-selected' : ''}`}>
                    <input type="radio" name="theme" value={theme.id} checked={selected} class="sr-only" />
                    <div class="flex items-center justify-between gap-3">
                      <div>
                        <p class="text-sm font-medium text-primary">{theme.label}</p>
                        <p class="text-xs text-subtle">{theme.group}</p>
                      </div>
                      <div class="flex items-center gap-1">
                        {swatches.map((swatch) => (
                          <span
                            class="h-4 w-4 rounded-full border border-default"
                            style={`background-color: rgb(${swatch});`}
                          />
                        ))}
                      </div>
                    </div>
                  </label>
                );
              })}
            </div>
          </fieldset>

          <fieldset class="space-y-3">
            <legend class="text-sm text-muted" style="font-weight: var(--font-weight-semibold);">Header Font (for headings)</legend>
            <div class="grid gap-2">
              {headerFontList.map((font) => {
                const selected = currentHeaderFont.id === font.id;
                return (
                  <label class={`theme-option ${selected ? 'theme-option-selected' : ''}`}>
                    <input type="radio" name="font_header" value={font.id} checked={selected} class="sr-only" />
                    <div>
                      <p class="text-sm font-medium text-primary" style={`font-family: ${font.family}, ${font.fallback};`}>{font.label}</p>
                      <p class="text-xs text-subtle">{font.description}</p>
                    </div>
                  </label>
                );
              })}
            </div>
          </fieldset>

          <fieldset class="space-y-3">
            <legend class="text-sm text-muted" style="font-weight: var(--font-weight-semibold);">Body Font (for text)</legend>
            <div class="grid gap-2">
              {bodyFontList.map((font) => {
                const selected = currentBodyFont.id === font.id;
                return (
                  <label class={`theme-option ${selected ? 'theme-option-selected' : ''}`}>
                    <input type="radio" name="font_body" value={font.id} checked={selected} class="sr-only" />
                    <div>
                      <p class="text-sm font-medium text-primary" style={`font-family: ${font.family}, ${font.fallback};`}>{font.label}</p>
                      <p class="text-xs text-subtle">{font.description}</p>
                    </div>
                  </label>
                );
              })}
            </div>
          </fieldset>

          <fieldset class="space-y-3">
            <legend class="text-sm text-muted" style="font-weight: var(--font-weight-semibold);">Mono Font (for code & editor)</legend>
            <div class="grid gap-2">
              {monoFontList.map((font) => {
                const selected = currentMonoFont.id === font.id;
                return (
                  <label class={`theme-option ${selected ? 'theme-option-selected' : ''}`}>
                    <input type="radio" name="font_mono" value={font.id} checked={selected} class="sr-only" />
                    <div>
                      <p class="text-sm font-medium text-primary font-mono" style={`font-family: ${font.family}, ${font.fallback};`}>{font.label}</p>
                      <p class="text-xs text-subtle">{font.description}</p>
                    </div>
                  </label>
                );
              })}
            </div>
          </fieldset>

          <button
            type="submit"
            class="inline-flex items-center gap-2 px-4 py-2 rounded-lg font-medium transition-colors btn-primary"
          >
            Save branding
          </button>
        </form>
        <div id="branding-feedback"></div>
      </section>

      <section class="panel" style="padding: var(--spacing-card); display: flex; flex-direction: column; gap: var(--spacing-element);">
        <div>
          <h2 class="text-lg text-primary" style="font-weight: var(--font-weight-semibold); margin-bottom: 0.5rem;">App icon</h2>
          <p class="text-sm text-subtle">
            Upload a 512x512 PNG, JPG, or WebP. We generate all required favicon and iOS sizes.
          </p>
        </div>

        <div class="flex items-center gap-4">
          <div class="w-20 h-20 rounded-2xl bg-surface-muted border border-default flex items-center justify-center overflow-hidden">
            <img src={`/icons/apple-touch-icon-180.png${iconQuery}`} alt="App icon preview" class="w-full h-full object-cover" />
          </div>
          <div class="text-sm text-muted">
            <p>Current icon preview</p>
            <p class="text-xs text-subtle">Reload after upload to refresh</p>
          </div>
        </div>

        <form
          hx-post="/api/branding-icon"
          hx-target="#icon-feedback"
          hx-swap="innerHTML"
          hx-encoding="multipart/form-data"
          class="space-y-4"
        >
          <input
            type="file"
            name="icon"
            accept="image/png,image/jpeg,image/webp"
            class="block w-full text-sm text-muted file:mr-4 file:py-2 file:px-4
                   file:rounded-lg file:border-0"
          />
          <button
            type="submit"
            class="inline-flex items-center gap-2 px-4 py-2 rounded-lg font-medium transition-colors btn-secondary"
          >
            Upload icon
          </button>
        </form>
        <div id="icon-feedback"></div>
      </section>

      <section class="panel" style="padding: var(--spacing-card); display: flex; flex-direction: column; gap: var(--spacing-element);">
        <div>
          <h2 class="text-lg text-primary" style="font-weight: var(--font-weight-semibold); margin-bottom: 0.5rem;">Install as App</h2>
          <p class="text-sm text-subtle">
            Add {branding.app_name} to your home screen for a native app experience.
          </p>
        </div>

        <details class="space-y-3">
          <summary class="cursor-pointer text-sm font-medium text-primary hover:text-accent transition-colors flex items-center gap-2">
            <Icon name="smartphone-linear" size={18} class="text-primary" />
            <span>Installation instructions</span>
          </summary>
          <div class="mt-3 space-y-4 text-sm text-muted">
            <div class="p-4 rounded-lg bg-surface-muted border border-default">
              <h3 class="font-medium text-primary mb-2">iOS (iPhone/iPad)</h3>
              <ol class="list-decimal list-inside space-y-1">
                <li>Open this page in Safari</li>
                <li class="flex items-center gap-1">
                  <span>Tap the Share button</span>
                  <span class="inline-flex items-center px-1.5 py-0.5 rounded bg-surface">
                    <Icon name="upload-linear" size={14} class="text-primary" />
                  </span>
                </li>
                <li>Scroll down and tap "Add to Home Screen"</li>
                <li>Tap "Add" to confirm</li>
              </ol>
            </div>

            <div class="p-4 rounded-lg bg-surface-muted border border-default">
              <h3 class="font-medium text-primary mb-2">Android (Chrome)</h3>
              <ol class="list-decimal list-inside space-y-1">
                <li class="flex items-center gap-1">
                  <span>Tap the menu button</span>
                  <span class="inline-flex items-center px-1.5 py-0.5 rounded bg-surface">
                    <Icon name="menu-dots-bold" size={14} class="text-primary" />
                  </span>
                </li>
                <li>Tap "Install app" or "Add to Home screen"</li>
                <li>Confirm the installation</li>
              </ol>
            </div>

            <p class="text-xs text-subtle">
              Once installed, the app will open in standalone mode without browser UI.
            </p>
          </div>
        </details>
      </section>
      </div>
    </div>
  </main>

  <script>
    // Save theme and fonts to localStorage when branding form is submitted
    document.addEventListener('htmx:afterRequest', (event) => {
      const target = event.detail.target;
      if (target && target.id === 'branding-feedback') {
        // Get the selected theme and fonts from the form
        const form = document.querySelector('form[hx-post="/api/branding"]');
        if (form) {
          const themeInput = form.querySelector('input[name="theme"]:checked');
          const headerFontInput = form.querySelector('input[name="font_header"]:checked');
          const bodyFontInput = form.querySelector('input[name="font_body"]:checked');
          const monoFontInput = form.querySelector('input[name="font_mono"]:checked');

          if (themeInput) {
            const selectedTheme = themeInput.value;
            localStorage.setItem('athena-theme', selectedTheme);

            // Remove auto-theme flag if user explicitly selects a theme
            document.documentElement.removeAttribute('data-auto-theme');
          }

          if (headerFontInput) {
            const selectedFont = headerFontInput.value;
            localStorage.setItem('athena-font-header', selectedFont);
          }

          if (bodyFontInput) {
            const selectedFont = bodyFontInput.value;
            localStorage.setItem('athena-font-body', selectedFont);
          }

          if (monoFontInput) {
            const selectedFont = monoFontInput.value;
            localStorage.setItem('athena-font-mono', selectedFont);
          }

          // Reload to apply the new theme and fonts
          setTimeout(() => window.location.reload(), 500);
        }
      }
    });
  </script>
</Layout>
