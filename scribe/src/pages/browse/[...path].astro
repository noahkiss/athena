---
import Layout from '../../layouts/Layout.astro';
import Icon from '../../components/Icon.astro';
import EmptyState from '../../components/EmptyState.astro';
import ContactCard from '../../components/ContactCard.astro';
import { marked } from 'marked';
import DOMPurify from 'isomorphic-dompurify';

const GARDENER_URL =
  process.env.GARDENER_URL ||
  import.meta.env.GARDENER_URL ||
  'http://localhost:8000';
const AUTH_TOKEN =
  process.env.ATHENA_AUTH_TOKEN ||
  import.meta.env.ATHENA_AUTH_TOKEN ||
  '';
const authHeaders = AUTH_TOKEN
  ? { Authorization: `Bearer ${AUTH_TOKEN}`, 'X-Auth-Token': AUTH_TOKEN }
  : {};

const { path } = Astro.params;
const currentPath = path || '';

// Check if we're in the people category
const isPeopleCategory = currentPath.startsWith('people');

let data: any = null;
let error: string | null = null;
let recentActivity: any[] = [];

try {
  const url = currentPath
    ? `${GARDENER_URL}/api/browse/${currentPath}`
    : `${GARDENER_URL}/api/browse`;
  const response = await fetch(url, { headers: authHeaders });
  if (response.ok) {
    data = await response.json();
  } else {
    error = `Failed to load: ${response.status}`;
  }
} catch (e) {
  error = 'Could not connect to Gardener. Is it running?';
}

// Fetch recent activity only on root browse page
if (!currentPath) {
  try {
    const recentResponse = await fetch(`${GARDENER_URL}/api/recent?limit=8`, { headers: authHeaders });
    if (recentResponse.ok) {
      const recentData = await recentResponse.json();
      recentActivity = recentData.recent || [];
    }
  } catch (e) {
    // Silently fail - recent activity is optional
  }
}

// Fetch contacts when viewing the people directory OR when viewing a file (for @mention linking)
let contacts: any[] = [];
if (currentPath === 'people' || data?.is_file) {
  try {
    const contactsResponse = await fetch(`${GARDENER_URL}/api/contacts`, { headers: authHeaders });
    if (contactsResponse.ok) {
      const contactsData = await contactsResponse.json();
      contacts = contactsData.contacts || [];
    }
  } catch (e) {
    // Fall back to regular directory listing
  }
}

// Build a map of contact names to their paths for @mention linking
const contactNameMap = new Map<string, string>();
contacts.forEach((contact: any) => {
  if (contact.name) {
    // Store lowercase name for case-insensitive matching
    contactNameMap.set(contact.name.toLowerCase(), contact.path);
    // Also store first name only for partial matches
    const firstName = contact.name.split(' ')[0];
    if (firstName && !contactNameMap.has(firstName.toLowerCase())) {
      contactNameMap.set(firstName.toLowerCase(), contact.path);
    }
  }
});

// Transform @mentions to links in markdown content
function processMentions(content: string): string {
  // Match @Name or @FirstName LastName (with optional quotes for multi-word)
  // Patterns: @John, @"John Doe", @John-Doe
  return content.replace(
    /@(?:"([^"]+)"|(\w+(?:[-\s]\w+)?))/g,
    (match, quotedName, simpleName) => {
      const name = quotedName || simpleName;
      const lowerName = name.toLowerCase().replace(/[-\s]+/g, ' ').trim();

      // Try exact match first
      const exactPath = contactNameMap.get(lowerName);
      if (exactPath) {
        return `[@${name}](/browse/${exactPath})`;
      }

      // Try matching just the first word
      const firstName = lowerName.split(' ')[0];
      const firstNamePath = contactNameMap.get(firstName);
      if (firstNamePath) {
        return `[@${name}](/browse/${firstNamePath})`;
      }

      // No match found, return original
      return match;
    }
  );
}

// Build breadcrumb parts
const pathParts = currentPath ? currentPath.split('/').filter(Boolean) : [];
const breadcrumbs = pathParts.map((part, index) => ({
  name: part,
  path: pathParts.slice(0, index + 1).join('/'),
}));

const categoryStyles: Record<string, { className: string; icon: string }> = {
  projects: { className: 'category-1', icon: 'case-linear' },
  people: { className: 'category-2', icon: 'users-group-rounded-linear' },
  journal: { className: 'category-3', icon: 'notebook-linear' },
  tech: { className: 'category-4', icon: 'settings-linear' },
  reading: { className: 'category-5', icon: 'book-2-linear' },
  wellness: { className: 'category-6', icon: 'health-linear' },
  home: { className: 'category-7', icon: 'home-2-linear' },
};

const categoryFallbacks = [
  'category-1',
  'category-2',
  'category-3',
  'category-4',
  'category-5',
  'category-6',
  'category-7',
  'category-8',
];

function getCategoryStyle(name: string) {
  const lowerName = name.toLowerCase();

  // Check if it's a known category
  for (const [key, value] of Object.entries(categoryStyles)) {
    if (lowerName.includes(key)) {
      return value;
    }
  }

  // Hash-based color for unknown categories
  const hash = name.split('').reduce((acc, char) => acc + char.charCodeAt(0), 0);
  return { className: categoryFallbacks[hash % categoryFallbacks.length], icon: 'folder-linear' };
}

function formatRelativeTime(timestamp: number): string {
  const now = Date.now() / 1000; // Current time in seconds
  const diff = now - timestamp;

  if (diff < 60) return 'just now';
  if (diff < 3600) return `${Math.floor(diff / 60)}m ago`;
  if (diff < 86400) return `${Math.floor(diff / 3600)}h ago`;
  if (diff < 604800) return `${Math.floor(diff / 86400)}d ago`;
  if (diff < 2592000) return `${Math.floor(diff / 604800)}w ago`;
  return `${Math.floor(diff / 2592000)}mo ago`;
}

// Strip YAML frontmatter from content before rendering
function stripFrontmatter(content: string): string {
  const frontmatterRegex = /^---\s*\n([\s\S]*?)\n---\s*\n?/;
  return content.replace(frontmatterRegex, '');
}

// Render markdown if it's a file, then sanitize to prevent XSS
let renderedContent = '';
if (data?.is_file && data?.content) {
  // Strip frontmatter before rendering (metadata is already parsed by backend)
  let contentWithoutFrontmatter = stripFrontmatter(data.content);
  // Process @mentions to convert them to links before markdown rendering
  contentWithoutFrontmatter = processMentions(contentWithoutFrontmatter);
  const rawHtml = await marked(contentWithoutFrontmatter);
  renderedContent = DOMPurify.sanitize(rawHtml);
}

// Check if this is a contact (has contact-specific metadata)
const isContact = data?.metadata?.name || data?.metadata?.email || data?.metadata?.phone;
---

<Layout title={`Browse - ${currentPath || 'Atlas'}`}>
  <main class="min-h-screen p-4 md:p-8">
    <div class="max-w-4xl mx-auto">
      <header class="page-header">
        <h1 class="page-title">Browse</h1>
        <nav class="page-nav">
          <a href="/" class="nav-link">Capture</a>
          <a href="/dashboard" class="nav-link">Dashboard</a>
          <a href="/timeline" class="nav-link">Timeline</a>
          <button
            id="random-note-btn"
            class="nav-link cursor-pointer flex items-center gap-1.5"
            title="Random note (Ctrl+Shift+R)"
          >
            <Icon name="shuffle-linear" size={18} />
            <span>Random</span>
          </button>
          <a href="/archive" class="nav-link">Archive</a>
          <a href="/settings" class="nav-link">Settings</a>
        </nav>
      </header>

      <!-- Breadcrumb -->
      <nav class="mb-6 text-sm" aria-label="Breadcrumb">
        <ol class="flex flex-wrap items-center gap-1">
          <li>
            <a href="/browse" class="breadcrumb-item flex items-center gap-1.5 px-2 py-1 rounded-md hover:bg-surface-muted transition-all">
              <Icon name="library-linear" size={16} class="text-muted" />
              <span class="text-muted hover:text-primary">atlas</span>
            </a>
          </li>
          {breadcrumbs.map((crumb, i) => {
            const category = getCategoryStyle(crumb.name);
            const isLast = i === breadcrumbs.length - 1;
            return (
              <li class="flex items-center">
                <Icon name="alt-arrow-right-linear" size={14} class="text-subtle mx-1" />
                {isLast ? (
                  <span class={`breadcrumb-item flex items-center gap-1.5 px-2 py-1 rounded-md ${category.className} category-chip`}>
                    <Icon name={category.icon} size={16} class="breadcrumb-icon" />
                    <span class="font-medium">{crumb.name}</span>
                  </span>
                ) : (
                  <a href={`/browse/${crumb.path}`} class={`breadcrumb-item flex items-center gap-1.5 px-2 py-1 rounded-md hover:bg-surface-muted transition-all`}>
                    <Icon name={category.icon} size={16} class={`breadcrumb-icon ${category.className} category-text`} />
                    <span class={`${category.className} category-text`}>{crumb.name}</span>
                  </a>
                )}
              </li>
            );
          })}
        </ol>
      </nav>

      <!-- Recent Activity (only on root browse page) -->
      {!currentPath && recentActivity.length > 0 && (
        <details class="mb-6 panel" open>
          <summary class="cursor-pointer p-4 font-medium text-primary hover:text-accent transition-colors flex items-center justify-between">
            <span class="flex items-center gap-2">
              <Icon name="bolt-linear" size={20} class="text-primary" />
              <span>Recent Activity</span>
            </span>
            <span class="text-xs text-subtle">Last {recentActivity.length} notes</span>
          </summary>
          <div class="px-4 pb-4 space-y-2">
            {recentActivity.map((item: any) => {
              const category = item.category ? getCategoryStyle(item.category) : null;
              const fileName = item.path.split('/').pop()?.replace('.md', '') || item.path;
              const relativeTime = formatRelativeTime(item.timestamp);

              return (
                <a
                  href={`/browse/${item.path}`}
                  class="flex items-center gap-3 p-2 rounded-lg hover:bg-surface-muted transition-colors group"
                >
                  <Icon name={category?.icon || 'document-linear'} size={20} class="text-primary" />
                  <span class="flex-1 text-sm">
                    <span class={category ? `category-text ${category.className}` : 'text-primary'}>
                      {fileName}
                    </span>
                    {item.category && (
                      <span class="text-xs text-subtle ml-2">in {item.category}</span>
                    )}
                  </span>
                  <span class="text-xs text-subtle opacity-60 group-hover:opacity-100 transition-opacity">
                    {relativeTime}
                  </span>
                </a>
              );
            })}
          </div>
        </details>
      )}

      {error ? (
        <div class="p-4 bg-danger-soft border border-danger rounded-lg">
          <p class="text-danger">{error}</p>
        </div>
      ) : data?.is_file ? (
        <!-- File content (direct navigation) -->
        <div>
          {/* Show contact card header for contacts in people category */}
          {isPeopleCategory && isContact && (
            <ContactCard
              metadata={data.metadata}
              filePath={currentPath}
              variant="detail"
            />
          )}
          {/* Show markdown content (notes section for contacts, or full content for other files) */}
          <article class="prose prose-sm max-w-none prose-theme">
            <div set:html={renderedContent} />
          </article>
        </div>
      ) : (
        <!-- Directory listing with preview -->
        <div class="browse-container">
          <div id="file-list" class="file-list space-y-1">
            {data?.items?.length === 0 ? (
              <EmptyState
                icon="folder-open-linear"
                title="This folder is waiting for its first note"
                description="The Gardener will automatically file notes here based on their content. Just capture your thoughts and let the AI organize them for you."
                actionText="Capture a note →"
                actionHref="/"
              >
                {currentPath.includes('projects') && (
                  <div class="mb-6 p-4 panel text-left max-w-md">
                    <h3 class="text-sm font-semibold text-muted mb-2">What goes in Projects?</h3>
                    <ul class="text-sm text-subtle space-y-1">
                      <li>• Work projects and deliverables</li>
                      <li>• Side projects and ideas</li>
                      <li>• Project plans and progress notes</li>
                    </ul>
                  </div>
                )}
                {currentPath.includes('people') && (
                  <div class="mb-6 p-4 panel text-left max-w-md">
                    <h3 class="text-sm font-semibold text-muted mb-2">What goes in People?</h3>
                    <ul class="text-sm text-subtle space-y-1">
                      <li>• Contact notes and details</li>
                      <li>• Meeting summaries</li>
                      <li>• Relationship reminders</li>
                    </ul>
                  </div>
                )}
                {currentPath.includes('journal') && (
                  <div class="mb-6 p-4 panel text-left max-w-md">
                    <h3 class="text-sm font-semibold text-muted mb-2">What goes in Journal?</h3>
                    <ul class="text-sm text-subtle space-y-1">
                      <li>• Daily reflections and thoughts</li>
                      <li>• Mood logs and gratitude</li>
                      <li>• Personal observations</li>
                    </ul>
                  </div>
                )}
              </EmptyState>
            ) : contacts.length > 0 ? (
              /* Contact grid view for people directory */
              <div>
                {/* Toolbar: filters, sort, and add button */}
                <div class="flex flex-wrap items-center gap-3 mb-4">
                  {/* Relationship filter */}
                  <div class="flex items-center gap-2">
                    <label for="filter-relationship" class="text-sm text-muted">Filter:</label>
                    <select
                      id="filter-relationship"
                      class="text-sm px-2 py-1.5 rounded-lg bg-surface-muted border border-default text-primary focus:outline-none focus:ring-2 focus:ring-accent"
                    >
                      <option value="">All relationships</option>
                      <option value="colleague">Colleague</option>
                      <option value="friend">Friend</option>
                      <option value="family">Family</option>
                      <option value="mentor">Mentor</option>
                      <option value="client">Client</option>
                    </select>
                  </div>

                  {/* Sort dropdown */}
                  <div class="flex items-center gap-2">
                    <label for="sort-contacts" class="text-sm text-muted">Sort:</label>
                    <select
                      id="sort-contacts"
                      class="text-sm px-2 py-1.5 rounded-lg bg-surface-muted border border-default text-primary focus:outline-none focus:ring-2 focus:ring-accent"
                    >
                      <option value="name">Name</option>
                      <option value="last_contact">Last Contact</option>
                      <option value="company">Company</option>
                      <option value="relationship">Relationship</option>
                    </select>
                  </div>

                  {/* Results count */}
                  <span id="contacts-count" class="text-sm text-subtle ml-auto">
                    {contacts.length} contact{contacts.length !== 1 ? 's' : ''}
                  </span>

                  {/* Add Contact button */}
                  <button
                    type="button"
                    id="add-contact-btn"
                    class="btn-primary flex items-center gap-2 px-4 py-2 rounded-lg text-sm font-medium"
                  >
                    <Icon name="user-plus-linear" size={18} />
                    <span>Add Contact</span>
                  </button>
                </div>

                {/* Contacts grid - will be managed by JS for filtering/sorting */}
                <div id="contacts-grid" class="contacts-grid" data-contacts={JSON.stringify(contacts)}>
                  {contacts.map((contact: any) => (
                    <ContactCard
                      metadata={contact.metadata}
                      filePath={contact.path}
                      variant="card"
                    />
                  ))}
                </div>
              </div>
            ) : (
              /* Regular directory listing */
              data?.items?.map((item: any, index: number) => {
                const category = item.type === 'directory' ? getCategoryStyle(item.name) : null;
                const isDirectory = item.type === 'directory';
                const fileIndex = data?.items?.filter((i: any) => i.type === 'file').findIndex((f: any) => f.path === item.path);
                return isDirectory ? (
                  <a
                    href={`/browse/${item.path}`}
                    class={`browse-item flex items-center gap-3 p-3 rounded-lg transition-all group stagger-item category-chip ${category?.className}`}
                  >
                    <span class="browse-item-icon flex-shrink-0 folder-icon">
                      <Icon
                        name={category?.icon || 'folder-linear'}
                        size={24}
                        class={`category-text ${category?.className}`}
                      />
                    </span>
                    <span class={`flex-1 truncate category-text ${category?.className}`}>
                      {item.name}
                    </span>
                    <Icon
                      name="alt-arrow-right-linear"
                      size={18}
                      class={`browse-item-arrow opacity-40 group-hover:opacity-100 transition-all category-text ${category?.className}`}
                    />
                  </a>
                ) : (
                  <button
                    type="button"
                    data-file-path={item.path}
                    data-file-index={fileIndex}
                    class="browse-item file-preview-trigger w-full text-left flex items-center gap-3 p-3 rounded-lg transition-all group stagger-item hover:bg-surface-muted"
                  >
                    <span class="browse-item-icon flex-shrink-0 file-icon">
                      <Icon name="document-linear" size={24} class="text-primary" />
                    </span>
                    <span class="flex-1 truncate text-primary">
                      {item.name.replace('.md', '')}
                    </span>
                    <span class="text-xs text-subtle opacity-0 group-hover:opacity-60 transition-opacity">
                      .md
                    </span>
                  </button>
                );
              })
            )}
          </div>

          <!-- File Preview Panel (Desktop: side panel, Mobile: modal) -->
          <div id="preview-panel" class="preview-panel hidden">
            <div class="preview-panel-inner panel">
              <!-- Header -->
              <div class="preview-header sticky top-0 bg-surface border-b border-default p-4 flex items-center justify-between gap-3 z-10">
                <div class="flex items-center gap-2 min-w-0 flex-1">
                  <Icon name="document-linear" size={20} class="text-primary flex-shrink-0" />
                  <span id="preview-filename" class="font-medium text-primary truncate">Loading...</span>
                </div>
                <div class="flex items-center gap-1 flex-shrink-0">
                  <button
                    id="preview-prev"
                    type="button"
                    class="p-2 rounded-lg hover:bg-surface-muted transition-colors disabled:opacity-30 disabled:cursor-not-allowed"
                    title="Previous file (←)"
                    disabled
                  >
                    <Icon name="alt-arrow-left-linear" size={18} class="text-muted" />
                  </button>
                  <button
                    id="preview-next"
                    type="button"
                    class="p-2 rounded-lg hover:bg-surface-muted transition-colors disabled:opacity-30 disabled:cursor-not-allowed"
                    title="Next file (→)"
                    disabled
                  >
                    <Icon name="alt-arrow-right-linear" size={18} class="text-muted" />
                  </button>
                  <button
                    id="preview-close"
                    type="button"
                    class="p-2 rounded-lg hover:bg-surface-muted transition-colors ml-1"
                    title="Close (Esc)"
                  >
                    <Icon name="close-circle-linear" size={18} class="text-muted" />
                  </button>
                </div>
              </div>

              <!-- Breadcrumb -->
              <div id="preview-breadcrumb" class="px-4 py-2 text-xs text-subtle border-b border-default bg-surface-muted">
                <span class="opacity-60">atlas</span>
              </div>

              <!-- Content -->
              <div id="preview-content" class="preview-content p-4 md:p-6 overflow-auto">
                <div class="preview-loading flex items-center justify-center py-12">
                  <div class="w-6 h-6 border-2 border-muted border-t-accent rounded-full animate-spin"></div>
                </div>
              </div>

              <!-- Footer with actions -->
              <div class="preview-footer sticky bottom-0 bg-surface border-t border-default p-3 flex items-center justify-between gap-2">
                <a
                  id="preview-open-link"
                  href="#"
                  class="btn-secondary text-sm px-3 py-1.5 rounded-lg flex items-center gap-1.5"
                >
                  <Icon name="arrow-right-up-linear" size={16} />
                  <span>Open</span>
                </a>
                <div class="flex items-center gap-1">
                  <button
                    id="preview-copy-link"
                    type="button"
                    class="p-2 rounded-lg hover:bg-surface-muted transition-colors"
                    title="Copy link"
                  >
                    <Icon name="link-linear" size={18} class="text-muted" />
                  </button>
                  <button
                    id="preview-download"
                    type="button"
                    class="p-2 rounded-lg hover:bg-surface-muted transition-colors"
                    title="Download"
                  >
                    <Icon name="download-linear" size={18} class="text-muted" />
                  </button>
                </div>
              </div>
            </div>
          </div>

          <!-- Mobile overlay backdrop -->
          <div id="preview-backdrop" class="preview-backdrop hidden"></div>
        </div>
      )}
    </div>
  </main>

  <!-- Add Contact Modal -->
  <div id="add-contact-modal" class="fixed inset-0 z-50 hidden">
    <div id="add-contact-backdrop" class="absolute inset-0 bg-black/60 backdrop-blur-sm"></div>
    <div class="absolute inset-0 flex items-center justify-center p-4">
      <div class="panel w-full max-w-md p-6 relative animate-in fade-in slide-in-from-bottom-4 duration-200">
        <div class="flex items-center justify-between mb-4">
          <h2 class="text-lg font-semibold text-primary">Add Contact</h2>
          <button type="button" id="close-contact-modal" class="p-2 rounded-lg hover:bg-surface-muted transition-colors">
            <Icon name="close-circle-linear" size={20} class="text-muted" />
          </button>
        </div>
        <form id="add-contact-form" class="space-y-4">
          <div>
            <label for="contact-name" class="block text-sm font-medium text-muted mb-1">Name *</label>
            <input type="text" id="contact-name" name="name" required
              class="w-full px-3 py-2 rounded-lg bg-surface-muted border border-default text-primary placeholder:text-subtle focus:outline-none focus:ring-2 focus:ring-accent"
              placeholder="John Doe">
          </div>
          <div class="grid grid-cols-2 gap-4">
            <div>
              <label for="contact-email" class="block text-sm font-medium text-muted mb-1">Email</label>
              <input type="email" id="contact-email" name="email"
                class="w-full px-3 py-2 rounded-lg bg-surface-muted border border-default text-primary placeholder:text-subtle focus:outline-none focus:ring-2 focus:ring-accent"
                placeholder="john@example.com">
            </div>
            <div>
              <label for="contact-phone" class="block text-sm font-medium text-muted mb-1">Phone</label>
              <input type="tel" id="contact-phone" name="phone"
                class="w-full px-3 py-2 rounded-lg bg-surface-muted border border-default text-primary placeholder:text-subtle focus:outline-none focus:ring-2 focus:ring-accent"
                placeholder="+1-555-0100">
            </div>
          </div>
          <div class="grid grid-cols-2 gap-4">
            <div>
              <label for="contact-company" class="block text-sm font-medium text-muted mb-1">Company</label>
              <input type="text" id="contact-company" name="company"
                class="w-full px-3 py-2 rounded-lg bg-surface-muted border border-default text-primary placeholder:text-subtle focus:outline-none focus:ring-2 focus:ring-accent"
                placeholder="Acme Corp">
            </div>
            <div>
              <label for="contact-role" class="block text-sm font-medium text-muted mb-1">Role</label>
              <input type="text" id="contact-role" name="role"
                class="w-full px-3 py-2 rounded-lg bg-surface-muted border border-default text-primary placeholder:text-subtle focus:outline-none focus:ring-2 focus:ring-accent"
                placeholder="Software Engineer">
            </div>
          </div>
          <div>
            <label for="contact-relationship" class="block text-sm font-medium text-muted mb-1">Relationship</label>
            <select id="contact-relationship" name="relationship"
              class="w-full px-3 py-2 rounded-lg bg-surface-muted border border-default text-primary focus:outline-none focus:ring-2 focus:ring-accent">
              <option value="">Select...</option>
              <option value="colleague">Colleague</option>
              <option value="friend">Friend</option>
              <option value="family">Family</option>
              <option value="mentor">Mentor</option>
              <option value="client">Client</option>
            </select>
          </div>
          <div>
            <label for="contact-notes" class="block text-sm font-medium text-muted mb-1">Initial Notes</label>
            <textarea id="contact-notes" name="notes" rows="3"
              class="w-full px-3 py-2 rounded-lg bg-surface-muted border border-default text-primary placeholder:text-subtle focus:outline-none focus:ring-2 focus:ring-accent resize-none"
              placeholder="How did you meet? Any initial notes..."></textarea>
          </div>
          <div class="flex justify-end gap-3 pt-2">
            <button type="button" id="cancel-contact" class="btn-secondary px-4 py-2 rounded-lg text-sm font-medium">
              Cancel
            </button>
            <button type="submit" class="btn-primary px-4 py-2 rounded-lg text-sm font-medium flex items-center gap-2">
              <Icon name="check-circle-linear" size={18} />
              <span>Create Contact</span>
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <style>
    /* Contacts grid for people directory */
    .contacts-grid {
      display: grid;
      grid-template-columns: 1fr;
      gap: 0.75rem;
      max-width: 100%;
    }

    /* Tablet portrait and up: 2 columns */
    @media (min-width: 768px) {
      .contacts-grid {
        grid-template-columns: repeat(2, 1fr);
        gap: 1rem;
      }
    }

    /* Browse container - responsive layout */
    .browse-container {
      display: block;
    }

    /* Desktop: side-by-side layout when preview is open */
    @media (min-width: 1024px) {
      .browse-container {
        display: flex;
        gap: 1.5rem;
      }

      .browse-container .file-list {
        flex: 1;
        min-width: 0;
        max-width: 400px;
      }

      .browse-container.preview-open .file-list {
        max-width: 320px;
      }

      .preview-panel {
        position: sticky;
        top: 2rem;
        flex: 1;
        min-width: 0;
        max-height: calc(100vh - 4rem);
        display: flex;
        flex-direction: column;
      }

      .preview-panel-inner {
        display: flex;
        flex-direction: column;
        height: 100%;
        max-height: calc(100vh - 4rem);
        overflow: hidden;
      }

      .preview-content {
        flex: 1;
        overflow-y: auto;
      }

      .preview-backdrop {
        display: none !important;
      }
    }

    /* Mobile/Tablet: modal overlay */
    @media (max-width: 1023px) {
      .preview-panel {
        position: fixed;
        inset: 0;
        z-index: 50;
        display: flex;
        align-items: flex-end;
        justify-content: center;
        padding: 1rem;
        padding-bottom: calc(1rem + env(safe-area-inset-bottom, 0));
      }

      .preview-panel-inner {
        width: 100%;
        max-width: 100%;
        max-height: 85vh;
        display: flex;
        flex-direction: column;
        animation: slideUp var(--transition-base) var(--ease-out);
      }

      .preview-content {
        flex: 1;
        overflow-y: auto;
        -webkit-overflow-scrolling: touch;
      }

      .preview-backdrop {
        position: fixed;
        inset: 0;
        background: rgba(0, 0, 0, 0.6);
        backdrop-filter: blur(4px);
        z-index: 49;
        animation: fadeIn var(--transition-fast) var(--ease-out);
      }
    }

    /* Preview panel states */
    .preview-panel.hidden,
    .preview-backdrop.hidden {
      display: none;
    }

    /* File item selected state */
    .file-preview-trigger.selected {
      background-color: var(--color-surface-muted);
      border-color: var(--color-border);
    }

    /* Browse item hover effects */
    .browse-item {
      border: 1px solid transparent;
    }

    .browse-item:hover {
      transform: translateX(4px);
    }

    .browse-item:active {
      transform: translateX(2px);
    }

    /* Icon animations */
    .browse-item-icon {
      transition: transform var(--transition-fast) var(--ease-out);
    }

    .browse-item:hover .folder-icon {
      transform: scale(1.1) rotate(-3deg);
    }

    .browse-item:hover .file-icon {
      transform: scale(1.05);
    }

    .browse-item-arrow {
      transition: transform var(--transition-fast) var(--ease-out),
                  opacity var(--transition-fast) var(--ease-in-out);
    }

    .browse-item:hover .browse-item-arrow {
      transform: translateX(4px);
    }

    /* Breadcrumb animations */
    .breadcrumb-item {
      transition: all var(--transition-fast) var(--ease-in-out);
    }

    .breadcrumb-item:hover .breadcrumb-icon {
      transform: scale(1.15) rotate(-5deg);
    }

    .breadcrumb-icon {
      transition: transform var(--transition-fast) var(--ease-out);
    }

    /* Keyboard hint in preview */
    .preview-kbd {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      min-width: 1.5rem;
      padding: 0.125rem 0.375rem;
      font-size: 0.6875rem;
      font-family: var(--font-mono);
      background: var(--color-surface-alt);
      border: 1px solid var(--color-border);
      border-radius: 0.25rem;
      color: var(--color-text-subtle);
    }

    /* Syntax highlighting using theme colors */
    .hljs {
      color: var(--color-text);
      background: transparent;
    }

    .hljs-comment,
    .hljs-quote {
      color: var(--color-text-subtle);
      font-style: italic;
    }

    .hljs-keyword,
    .hljs-selector-tag,
    .hljs-addition {
      color: var(--accent);
    }

    .hljs-number,
    .hljs-string,
    .hljs-meta .hljs-meta-string,
    .hljs-literal,
    .hljs-doctag,
    .hljs-regexp {
      color: rgb(var(--category-3-rgb));
    }

    .hljs-title,
    .hljs-section,
    .hljs-name,
    .hljs-selector-id,
    .hljs-selector-class {
      color: rgb(var(--category-1-rgb));
    }

    .hljs-attribute,
    .hljs-attr,
    .hljs-variable,
    .hljs-template-variable,
    .hljs-class .hljs-title,
    .hljs-type {
      color: rgb(var(--category-4-rgb));
    }

    .hljs-symbol,
    .hljs-bullet,
    .hljs-subst,
    .hljs-meta,
    .hljs-meta .hljs-keyword,
    .hljs-selector-attr,
    .hljs-selector-pseudo,
    .hljs-link {
      color: rgb(var(--category-5-rgb));
    }

    .hljs-built_in,
    .hljs-deletion {
      color: rgb(var(--category-2-rgb));
    }

    .hljs-formula {
      background: var(--color-surface-muted);
    }

    .hljs-emphasis {
      font-style: italic;
    }

    .hljs-strong {
      font-weight: bold;
    }

    /* Respect reduced motion */
    @media (prefers-reduced-motion: reduce) {
      .browse-item,
      .browse-item-icon,
      .browse-item-arrow,
      .breadcrumb-item,
      .breadcrumb-icon,
      .preview-panel-inner,
      .preview-backdrop {
        transition: none;
        animation: none;
      }

      .browse-item:hover,
      .browse-item:hover .folder-icon,
      .browse-item:hover .file-icon,
      .browse-item:hover .browse-item-arrow,
      .breadcrumb-item:hover .breadcrumb-icon {
        transform: none;
      }
    }
  </style>

  <script>
    import { marked } from 'marked';
    import DOMPurify from 'isomorphic-dompurify';
    import hljs from 'highlight.js/lib/core';
    // Import common languages
    import javascript from 'highlight.js/lib/languages/javascript';
    import typescript from 'highlight.js/lib/languages/typescript';
    import python from 'highlight.js/lib/languages/python';
    import bash from 'highlight.js/lib/languages/bash';
    import json from 'highlight.js/lib/languages/json';
    import yaml from 'highlight.js/lib/languages/yaml';
    import markdown from 'highlight.js/lib/languages/markdown';
    import css from 'highlight.js/lib/languages/css';
    import xml from 'highlight.js/lib/languages/xml';
    import sql from 'highlight.js/lib/languages/sql';

    // Register languages
    hljs.registerLanguage('javascript', javascript);
    hljs.registerLanguage('js', javascript);
    hljs.registerLanguage('typescript', typescript);
    hljs.registerLanguage('ts', typescript);
    hljs.registerLanguage('python', python);
    hljs.registerLanguage('py', python);
    hljs.registerLanguage('bash', bash);
    hljs.registerLanguage('sh', bash);
    hljs.registerLanguage('shell', bash);
    hljs.registerLanguage('json', json);
    hljs.registerLanguage('yaml', yaml);
    hljs.registerLanguage('yml', yaml);
    hljs.registerLanguage('markdown', markdown);
    hljs.registerLanguage('md', markdown);
    hljs.registerLanguage('css', css);
    hljs.registerLanguage('html', xml);
    hljs.registerLanguage('xml', xml);
    hljs.registerLanguage('sql', sql);

    // Configure marked with syntax highlighting
    marked.setOptions({
      highlight: function(code: string, lang: string) {
        if (lang && hljs.getLanguage(lang)) {
          try {
            return hljs.highlight(code, { language: lang }).value;
          } catch (e) {
            // Fall through to auto-detection
          }
        }
        // Auto-detect language
        try {
          return hljs.highlightAuto(code).value;
        } catch (e) {
          return code;
        }
      },
    });

    const GARDENER_URL = import.meta.env.PUBLIC_GARDENER_URL || 'http://localhost:8000';

    // Auth helper
    function getAuthHeaders(): HeadersInit {
      const token = localStorage.getItem('authToken') || '';
      return token
        ? { 'Authorization': `Bearer ${token}`, 'X-Auth-Token': token }
        : {};
    }

    // File preview state
    interface PreviewState {
      isOpen: boolean;
      currentPath: string | null;
      currentIndex: number;
      files: Array<{ path: string; name: string }>;
      rawContent: string;
      cache: Map<string, { content: string; rendered: string }>;
    }

    const previewState: PreviewState = {
      isOpen: false,
      currentPath: null,
      currentIndex: -1,
      files: [],
      rawContent: '',
      cache: new Map(),
    };

    // DOM elements
    const previewPanel = document.getElementById('preview-panel');
    const previewBackdrop = document.getElementById('preview-backdrop');
    const previewContent = document.getElementById('preview-content');
    const previewFilename = document.getElementById('preview-filename');
    const previewBreadcrumb = document.getElementById('preview-breadcrumb');
    const previewOpenLink = document.getElementById('preview-open-link') as HTMLAnchorElement;
    const previewPrev = document.getElementById('preview-prev') as HTMLButtonElement;
    const previewNext = document.getElementById('preview-next') as HTMLButtonElement;
    const previewClose = document.getElementById('preview-close');
    const previewCopyLink = document.getElementById('preview-copy-link');
    const previewDownload = document.getElementById('preview-download');
    const browseContainer = document.querySelector('.browse-container');

    // Collect all files from the list
    function collectFiles() {
      const triggers = document.querySelectorAll('.file-preview-trigger');
      previewState.files = Array.from(triggers).map((el) => ({
        path: el.getAttribute('data-file-path') || '',
        name: el.querySelector('.truncate')?.textContent || '',
      }));
    }

    // Open preview for a file
    async function openPreview(filePath: string) {
      if (!previewPanel || !previewContent) return;

      previewState.isOpen = true;
      previewState.currentPath = filePath;
      previewState.currentIndex = previewState.files.findIndex(f => f.path === filePath);

      // Show panel and backdrop
      previewPanel.classList.remove('hidden');
      previewBackdrop?.classList.remove('hidden');
      browseContainer?.classList.add('preview-open');

      // Update selected state
      document.querySelectorAll('.file-preview-trigger').forEach(el => {
        el.classList.toggle('selected', el.getAttribute('data-file-path') === filePath);
      });

      // Update navigation buttons
      updateNavigationButtons();

      // Update filename and breadcrumb
      const fileName = filePath.split('/').pop()?.replace('.md', '') || filePath;
      if (previewFilename) previewFilename.textContent = fileName;

      const pathParts = filePath.split('/');
      pathParts.pop(); // Remove filename
      const breadcrumbHtml = ['atlas', ...pathParts].map((part, i) =>
        `<span class="${i === 0 ? 'opacity-60' : ''}">${part}</span>`
      ).join(' <span class="mx-1 opacity-40">/</span> ');
      if (previewBreadcrumb) previewBreadcrumb.innerHTML = breadcrumbHtml;

      // Update open link
      if (previewOpenLink) previewOpenLink.href = `/browse/${filePath}`;

      // Show loading state
      previewContent.innerHTML = `
        <div class="flex items-center justify-center py-12">
          <div class="animate-spin w-6 h-6 border-2 border-muted border-t-accent rounded-full"></div>
        </div>
      `;

      // Check cache first
      if (previewState.cache.has(filePath)) {
        const cached = previewState.cache.get(filePath)!;
        previewState.rawContent = cached.content;
        previewContent.innerHTML = `<article class="prose prose-sm max-w-none prose-theme">${cached.rendered}</article>`;
        return;
      }

      // Fetch file content
      const MAX_PREVIEW_SIZE = 100000; // ~100KB limit for preview
      try {
        const response = await fetch(`${GARDENER_URL}/api/browse/${filePath}`, {
          headers: getAuthHeaders(),
        });

        if (response.ok) {
          const data = await response.json();
          if (data.content) {
            previewState.rawContent = data.content;

            // Handle large files
            let contentToRender = data.content;
            let isTruncated = false;
            if (data.content.length > MAX_PREVIEW_SIZE) {
              // Find a good break point (end of paragraph or line)
              let breakPoint = MAX_PREVIEW_SIZE;
              const newlinePos = data.content.lastIndexOf('\n\n', MAX_PREVIEW_SIZE);
              if (newlinePos > MAX_PREVIEW_SIZE * 0.7) {
                breakPoint = newlinePos;
              }
              contentToRender = data.content.slice(0, breakPoint);
              isTruncated = true;
            }

            const rawHtml = await marked(contentToRender);
            let rendered = DOMPurify.sanitize(rawHtml);

            // Add truncation notice if needed
            if (isTruncated) {
              rendered += `
                <div class="mt-6 p-4 rounded-lg bg-surface-muted border border-default text-center">
                  <p class="text-sm text-muted mb-2">File is large (${Math.round(data.content.length / 1024)}KB) — showing first ${Math.round(contentToRender.length / 1024)}KB</p>
                  <a href="/browse/${filePath}" class="text-sm link">Open full file →</a>
                </div>
              `;
            }

            // Cache the result
            previewState.cache.set(filePath, { content: data.content, rendered });

            // Only update if still viewing this file
            if (previewState.currentPath === filePath) {
              previewContent.innerHTML = `<article class="prose prose-sm max-w-none prose-theme">${rendered}</article>`;
            }
          }
        } else {
          previewContent.innerHTML = `
            <div class="text-center py-12 text-muted">
              <p>Failed to load file</p>
            </div>
          `;
        }
      } catch (error) {
        previewContent.innerHTML = `
          <div class="text-center py-12 text-muted">
            <p>Could not connect to server</p>
          </div>
        `;
      }
    }

    // Close preview
    function closePreview() {
      if (!previewPanel) return;

      previewState.isOpen = false;
      previewState.currentPath = null;
      previewState.currentIndex = -1;

      previewPanel.classList.add('hidden');
      previewBackdrop?.classList.add('hidden');
      browseContainer?.classList.remove('preview-open');

      // Clear selected state
      document.querySelectorAll('.file-preview-trigger').forEach(el => {
        el.classList.remove('selected');
      });
    }

    // Navigate to previous/next file
    function navigatePreview(direction: 'prev' | 'next') {
      if (!previewState.isOpen || previewState.files.length === 0) return;

      const newIndex = direction === 'prev'
        ? previewState.currentIndex - 1
        : previewState.currentIndex + 1;

      if (newIndex >= 0 && newIndex < previewState.files.length) {
        openPreview(previewState.files[newIndex].path);
      }
    }

    // Update navigation button states
    function updateNavigationButtons() {
      if (previewPrev) {
        previewPrev.disabled = previewState.currentIndex <= 0;
      }
      if (previewNext) {
        previewNext.disabled = previewState.currentIndex >= previewState.files.length - 1;
      }
    }

    // Copy link to clipboard
    async function copyLink() {
      if (!previewState.currentPath) return;

      const url = `${window.location.origin}/browse/${previewState.currentPath}`;
      try {
        await navigator.clipboard.writeText(url);
        // Brief visual feedback
        if (previewCopyLink) {
          previewCopyLink.classList.add('text-success');
          setTimeout(() => previewCopyLink.classList.remove('text-success'), 1000);
        }
      } catch (error) {
        console.error('Failed to copy link:', error);
      }
    }

    // Download file
    function downloadFile() {
      if (!previewState.currentPath || !previewState.rawContent) return;

      const fileName = previewState.currentPath.split('/').pop() || 'note.md';
      const blob = new Blob([previewState.rawContent], { type: 'text/markdown' });
      const url = URL.createObjectURL(blob);

      const a = document.createElement('a');
      a.href = url;
      a.download = fileName;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    }

    // Initialize file preview
    function initFilePreview() {
      collectFiles();

      // File click handlers
      document.querySelectorAll('.file-preview-trigger').forEach(el => {
        el.addEventListener('click', (e) => {
          e.preventDefault();
          const path = el.getAttribute('data-file-path');
          if (path) openPreview(path);
        });
      });

      // Navigation buttons
      previewPrev?.addEventListener('click', () => navigatePreview('prev'));
      previewNext?.addEventListener('click', () => navigatePreview('next'));

      // Close buttons
      previewClose?.addEventListener('click', closePreview);
      previewBackdrop?.addEventListener('click', closePreview);

      // Quick actions
      previewCopyLink?.addEventListener('click', copyLink);
      previewDownload?.addEventListener('click', downloadFile);

      // Keyboard navigation
      document.addEventListener('keydown', (e) => {
        if (!previewState.isOpen) return;

        switch (e.key) {
          case 'Escape':
            closePreview();
            break;
          case 'ArrowLeft':
            if (!e.ctrlKey && !e.metaKey && !e.altKey) {
              e.preventDefault();
              navigatePreview('prev');
            }
            break;
          case 'ArrowRight':
            if (!e.ctrlKey && !e.metaKey && !e.altKey) {
              e.preventDefault();
              navigatePreview('next');
            }
            break;
        }
      });
    }

    // Random note functionality
    async function goToRandomNote() {
      try {
        const response = await fetch(`${GARDENER_URL}/api/random`, { headers: getAuthHeaders() });
        if (response.ok) {
          const data = await response.json();
          if (data.path) {
            window.location.href = `/browse/${data.path}`;
          }
        } else {
          console.error('Failed to get random note:', response.status);
          alert('Failed to get random note. Try again.');
        }
      } catch (error) {
        console.error('Error fetching random note:', error);
        alert('Could not connect to server.');
      }
    }

    // Handle button click
    document.getElementById('random-note-btn')?.addEventListener('click', goToRandomNote);

    // Handle keyboard shortcuts
    document.addEventListener('keydown', (e) => {
      // Random note: Ctrl+Shift+R or Cmd+Shift+R
      if ((e.ctrlKey || e.metaKey) && e.shiftKey && e.key === 'R') {
        e.preventDefault();
        goToRandomNote();
      }
    });

    // Initialize
    initFilePreview();

    // Add Contact Modal functionality
    const addContactBtn = document.getElementById('add-contact-btn');
    const addContactModal = document.getElementById('add-contact-modal');
    const addContactBackdrop = document.getElementById('add-contact-backdrop');
    const closeContactModal = document.getElementById('close-contact-modal');
    const cancelContact = document.getElementById('cancel-contact');
    const addContactForm = document.getElementById('add-contact-form') as HTMLFormElement;

    function openContactModal() {
      addContactModal?.classList.remove('hidden');
      document.getElementById('contact-name')?.focus();
    }

    function closeContactModalFn() {
      addContactModal?.classList.add('hidden');
      addContactForm?.reset();
    }

    addContactBtn?.addEventListener('click', openContactModal);
    closeContactModal?.addEventListener('click', closeContactModalFn);
    cancelContact?.addEventListener('click', closeContactModalFn);
    addContactBackdrop?.addEventListener('click', closeContactModalFn);

    // Handle form submission
    addContactForm?.addEventListener('submit', async (e) => {
      e.preventDefault();

      const formData = new FormData(addContactForm);
      const data = {
        name: formData.get('name') as string,
        email: formData.get('email') as string || undefined,
        phone: formData.get('phone') as string || undefined,
        company: formData.get('company') as string || undefined,
        role: formData.get('role') as string || undefined,
        relationship: formData.get('relationship') as string || undefined,
        notes: formData.get('notes') as string || undefined,
      };

      // Remove empty values
      Object.keys(data).forEach(key => {
        if (!data[key as keyof typeof data]) {
          delete data[key as keyof typeof data];
        }
      });

      try {
        const response = await fetch(`${GARDENER_URL}/api/contacts`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            ...getAuthHeaders(),
          },
          body: JSON.stringify(data),
        });

        if (response.ok) {
          const result = await response.json();
          closeContactModalFn();
          // Redirect to the new contact
          window.location.href = `/browse/${result.path}`;
        } else {
          const error = await response.json();
          alert(`Failed to create contact: ${error.detail || 'Unknown error'}`);
        }
      } catch (error) {
        console.error('Error creating contact:', error);
        alert('Could not connect to server. Please try again.');
      }
    });

    // Close modal on Escape
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape' && !addContactModal?.classList.contains('hidden')) {
        closeContactModalFn();
      }
    });

    // Mark as Contacted button handler
    document.querySelectorAll('.mark-contacted-btn').forEach(btn => {
      btn.addEventListener('click', async (e) => {
        const button = e.currentTarget as HTMLButtonElement;
        const contactPath = button.dataset.contactPath;
        if (!contactPath) return;

        // Disable button and show loading state
        button.disabled = true;
        const originalText = button.querySelector('span')?.textContent;
        const spanEl = button.querySelector('span');
        if (spanEl) spanEl.textContent = 'Updating...';

        try {
          const response = await fetch(`${GARDENER_URL}/api/contacts/last-contact`, {
            method: 'PATCH',
            headers: {
              'Content-Type': 'application/json',
              ...getAuthHeaders(),
            },
            body: JSON.stringify({ path: contactPath }),
          });

          if (response.ok) {
            const result = await response.json();
            // Update the display
            if (spanEl) spanEl.textContent = 'Updated!';
            // Refresh the page to show updated last_contact
            setTimeout(() => {
              window.location.reload();
            }, 500);
          } else {
            const error = await response.json();
            alert(`Failed to update: ${error.detail || 'Unknown error'}`);
            if (spanEl) spanEl.textContent = originalText || 'Mark Contacted';
            button.disabled = false;
          }
        } catch (error) {
          console.error('Error updating last contact:', error);
          alert('Could not connect to server. Please try again.');
          if (spanEl) spanEl.textContent = originalText || 'Mark Contacted';
          button.disabled = false;
        }
      });
    });

    // Contact filtering and sorting
    const filterRelationship = document.getElementById('filter-relationship') as HTMLSelectElement;
    const sortContacts = document.getElementById('sort-contacts') as HTMLSelectElement;
    const contactsGrid = document.getElementById('contacts-grid');
    const contactsCount = document.getElementById('contacts-count');

    function applyFiltersAndSort() {
      if (!contactsGrid) return;

      const cards = Array.from(contactsGrid.querySelectorAll('.contact-card')) as HTMLElement[];
      const relationshipFilter = filterRelationship?.value || '';
      const sortBy = sortContacts?.value || 'name';

      // Filter
      let visibleCards = cards.filter(card => {
        if (relationshipFilter && card.dataset.relationship !== relationshipFilter) {
          return false;
        }
        return true;
      });

      // Show/hide based on filter
      cards.forEach(card => {
        const shouldShow = visibleCards.includes(card);
        card.style.display = shouldShow ? '' : 'none';
      });

      // Sort visible cards
      visibleCards.sort((a, b) => {
        switch (sortBy) {
          case 'name':
            return (a.dataset.name || '').localeCompare(b.dataset.name || '');
          case 'last_contact':
            // Sort by date descending (most recent first)
            const dateA = a.dataset.lastContact || '';
            const dateB = b.dataset.lastContact || '';
            if (!dateA && !dateB) return 0;
            if (!dateA) return 1;
            if (!dateB) return -1;
            return dateB.localeCompare(dateA);
          case 'company':
            return (a.dataset.company || '').localeCompare(b.dataset.company || '');
          case 'relationship':
            return (a.dataset.relationship || '').localeCompare(b.dataset.relationship || '');
          default:
            return 0;
        }
      });

      // Reorder DOM elements
      visibleCards.forEach(card => {
        contactsGrid.appendChild(card);
      });

      // Update count
      if (contactsCount) {
        const count = visibleCards.length;
        contactsCount.textContent = `${count} contact${count !== 1 ? 's' : ''}`;
      }
    }

    filterRelationship?.addEventListener('change', applyFiltersAndSort);
    sortContacts?.addEventListener('change', applyFiltersAndSort);
  </script>
</Layout>
