---
import Layout from '../layouts/Layout.astro';
---

<Layout title="Athena - Capture">
  <main class="flex flex-col items-center justify-center min-h-screen p-4">
    <div class="w-full max-w-2xl">
      <div class="flex items-center justify-between mb-6">
        <h1 class="text-2xl font-light text-muted">Capture</h1>
        <div class="flex items-center gap-3 text-sm">
          <a href="/browse" class="link">
            Browse &rarr;
          </a>
          <a href="/archive" class="link">
            Archive &rarr;
          </a>
          <a href="/settings" class="link">
            Settings &rarr;
          </a>
        </div>
      </div>

      <form
        id="capture-form"
        hx-post="/api/inbox"
        hx-target="#feedback"
        hx-swap="innerHTML"
        hx-indicator="#submit-spinner"
        class="space-y-4"
      >
        <textarea
          name="content"
          id="note-input"
          placeholder="What's on your mind?"
          class="w-full h-64 p-4 rounded-lg input-field resize-none text-base md:text-sm transition-colors"
          autofocus
        ></textarea>

        <div class="flex flex-col gap-3 sm:flex-row">
          <button
            type="button"
            id="refine-btn"
            hx-post="/api/refine"
            hx-target="#suggestions"
            hx-swap="innerHTML"
            hx-include="#note-input"
            hx-indicator="#refine-spinner"
            class="relative flex-1 py-3 px-4 rounded-lg transition-all disabled:opacity-50 disabled:cursor-not-allowed btn-secondary"
          >
            <span class="btn-text">Refine</span>
            <span id="refine-spinner" class="htmx-indicator absolute inset-0 flex items-center justify-center">
              <svg class="animate-spin h-5 w-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
              </svg>
            </span>
          </button>
          <button
            type="button"
            id="ask-btn"
            hx-post="/api/ask"
            hx-target="#explore"
            hx-swap="innerHTML"
            hx-include="#note-input"
            hx-indicator="#ask-spinner"
            class="relative flex-1 py-3 px-4 rounded-lg transition-all disabled:opacity-50 disabled:cursor-not-allowed btn-secondary"
          >
            <span class="btn-text">Explore</span>
            <span id="ask-spinner" class="htmx-indicator absolute inset-0 flex items-center justify-center">
              <svg class="animate-spin h-5 w-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
              </svg>
            </span>
          </button>
          <button
            type="submit"
            id="submit-btn"
            class="relative flex-1 py-3 px-4 rounded-lg transition-all font-medium disabled:opacity-50 disabled:cursor-not-allowed btn-primary"
          >
            <span class="btn-text">Submit</span>
            <span id="submit-spinner" class="htmx-indicator absolute inset-0 flex items-center justify-center">
              <svg class="animate-spin h-5 w-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
              </svg>
            </span>
          </button>
        </div>
      </form>

      <div id="suggestions" class="mt-4 p-3 panel min-h-[60px] transition-all">
        <p class="text-subtle text-sm">Click "Refine" for AI suggestions</p>
      </div>

      <div id="explore" class="mt-4 p-3 panel min-h-[60px] transition-all">
        <p class="text-subtle text-sm">Click "Explore" to ask your notes</p>
      </div>

      <div id="feedback" class="mt-4 text-center"></div>
    </div>
  </main>
</Layout>

<style>
  /* Hide spinner by default, show when htmx request is active */
  .htmx-indicator {
    display: none;
  }

  .htmx-request .htmx-indicator {
    display: flex;
  }

  .htmx-request .btn-text {
    opacity: 0;
  }

  /* Smooth fade-in for results */
  #suggestions, #explore {
    animation: fadeIn 0.3s ease-in;
  }

  @keyframes fadeIn {
    from { opacity: 0; transform: translateY(-4px); }
    to { opacity: 1; transform: translateY(0); }
  }

  /* Success animation */
  .success-flash {
    animation: successPulse 0.6s ease-out;
  }

  @keyframes successPulse {
    0%, 100% { transform: scale(1); }
    50% { transform: scale(1.02); }
  }
</style>

<script>
  // Clear textarea on successful submit
  document.body.addEventListener('htmx:afterRequest', (event) => {
    const target = event.detail.elt;

    if (event.detail.successful && target?.id === 'submit-btn') {
      const textarea = document.getElementById('note-input') as HTMLTextAreaElement;
      if (textarea) {
        textarea.value = '';
        // Add success animation to feedback
        const feedback = document.getElementById('feedback');
        if (feedback) {
          feedback.classList.add('success-flash');
          setTimeout(() => feedback.classList.remove('success-flash'), 600);
        }
      }
    }
  });

  // Disable buttons during request
  document.body.addEventListener('htmx:beforeRequest', (event) => {
    const target = event.detail.elt as HTMLButtonElement;
    if (target) {
      target.disabled = true;
    }
  });

  document.body.addEventListener('htmx:afterRequest', (event) => {
    const target = event.detail.elt as HTMLButtonElement;
    if (target) {
      target.disabled = false;
    }
  });
</script>
