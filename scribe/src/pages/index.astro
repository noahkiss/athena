---
import Layout from '../layouts/Layout.astro';
---

<Layout title="Athena - Capture">
  <main class="min-h-screen p-4 md:p-8">
    <div class="max-w-2xl mx-auto">
      <header class="page-header">
        <h1 class="page-title">Capture</h1>
        <nav class="page-nav">
          <a href="/dashboard" class="nav-link">Dashboard</a>
          <a href="/browse" class="nav-link">Browse</a>
          <a href="/archive" class="nav-link">Archive</a>
          <a href="/settings" class="nav-link">Settings</a>
        </nav>
      </header>

      <form
        id="capture-form"
        hx-post="/api/inbox"
        hx-target="#feedback"
        hx-swap="innerHTML"
        hx-indicator="#submit-spinner"
        style="display: flex; flex-direction: column; gap: var(--spacing-element);"
      >
        <div class="relative">
          <textarea
            name="content"
            id="note-input"
            placeholder="What's on your mind?"
            class="w-full rounded-lg input-field textarea-autogrow focus-ring"
            style="padding: var(--spacing-card); font-size: var(--font-size-base); min-height: 16rem;"
            autofocus
            maxlength="50000"
          ></textarea>
          <div class="flex justify-between items-center mt-2 px-1">
            <span id="char-counter" class="char-counter">0 characters</span>
            <span class="text-xs text-subtle">Tip: Ctrl+Enter to submit</span>
          </div>
        </div>

        <div class="flex flex-col gap-3 sm:flex-row" style="gap: var(--spacing-element);">
          <button
            type="button"
            id="refine-btn"
            hx-post="/api/refine"
            hx-target="#suggestions"
            hx-swap="innerHTML"
            hx-include="#note-input"
            hx-indicator="#refine-spinner"
            class="relative flex-1 py-3 px-4 rounded-lg transition-all disabled:opacity-50 disabled:cursor-not-allowed btn-secondary btn-ripple focus-ring"
          >
            <span class="btn-text">Refine</span>
            <span id="refine-spinner" class="htmx-indicator absolute inset-0 flex items-center justify-center">
              <svg class="animate-spin h-5 w-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
              </svg>
            </span>
          </button>
          <button
            type="button"
            id="ask-btn"
            hx-post="/api/ask"
            hx-target="#explore"
            hx-swap="innerHTML"
            hx-include="#note-input"
            hx-indicator="#ask-spinner"
            class="relative flex-1 py-3 px-4 rounded-lg transition-all disabled:opacity-50 disabled:cursor-not-allowed btn-secondary btn-ripple focus-ring"
          >
            <span class="btn-text">Explore</span>
            <span id="ask-spinner" class="htmx-indicator absolute inset-0 flex items-center justify-center">
              <svg class="animate-spin h-5 w-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
              </svg>
            </span>
          </button>
          <button
            type="submit"
            id="submit-btn"
            class="relative flex-1 py-3 px-4 rounded-lg transition-all font-medium disabled:opacity-50 disabled:cursor-not-allowed btn-primary btn-ripple focus-ring"
          >
            <span class="btn-text">Submit</span>
            <span id="submit-spinner" class="htmx-indicator absolute inset-0 flex items-center justify-center">
              <svg class="animate-spin h-5 w-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
              </svg>
            </span>
          </button>
        </div>
      </form>

      <div id="suggestions" class="panel min-h-[60px] transition-all" style="margin-top: var(--spacing-section); padding: var(--spacing-card);">
        <p class="text-subtle" style="font-size: var(--font-size-sm);">Click "Refine" for AI suggestions</p>
      </div>

      <div id="explore" class="panel min-h-[60px] transition-all" style="margin-top: var(--spacing-element); padding: var(--spacing-card);">
        <p class="text-subtle" style="font-size: var(--font-size-sm);">Click "Explore" to ask your notes</p>
      </div>

      <div id="feedback" class="text-center" style="margin-top: var(--spacing-element);"></div>
    </div>
  </main>
</Layout>

<style>
  /* Hide spinner by default, show when htmx request is active */
  .htmx-indicator {
    display: none;
  }

  .htmx-request .htmx-indicator {
    display: flex;
  }

  .htmx-request .btn-text {
    opacity: 0;
  }

  /* Smooth fade-in for results */
  #suggestions, #explore {
    animation: fadeIn 0.3s ease-in;
  }

  @keyframes fadeIn {
    from { opacity: 0; transform: translateY(-4px); }
    to { opacity: 1; transform: translateY(0); }
  }

  /* Success animation */
  .success-flash {
    animation: successPulse 0.6s ease-out;
  }

  @keyframes successPulse {
    0%, 100% { transform: scale(1); }
    50% { transform: scale(1.02); }
  }
</style>

<script>
  const textarea = document.getElementById('note-input') as HTMLTextAreaElement;
  const charCounter = document.getElementById('char-counter');
  const MAX_CHARS = 50000;
  const WARN_THRESHOLD = 40000;
  const DANGER_THRESHOLD = 48000;

  // Auto-grow textarea
  function autoGrow() {
    if (!textarea) return;
    textarea.style.height = 'auto';
    textarea.style.height = Math.min(textarea.scrollHeight, window.innerHeight * 0.6) + 'px';
  }

  // Update character counter
  function updateCharCount() {
    if (!textarea || !charCounter) return;
    const count = textarea.value.length;
    const plural = count === 1 ? '' : 's';
    charCounter.textContent = `${count.toLocaleString()} character${plural}`;

    // Update counter color based on thresholds
    charCounter.classList.remove('warning', 'danger');
    if (count >= DANGER_THRESHOLD) {
      charCounter.classList.add('danger');
    } else if (count >= WARN_THRESHOLD) {
      charCounter.classList.add('warning');
    }
  }

  // Initialize and add event listeners
  if (textarea) {
    textarea.addEventListener('input', () => {
      autoGrow();
      updateCharCount();
    });

    // Initial setup
    autoGrow();
    updateCharCount();
  }

  // Clear textarea on successful submit
  document.body.addEventListener('htmx:afterRequest', (event) => {
    const target = event.detail.elt;

    if (event.detail.successful && target?.id === 'submit-btn') {
      if (textarea) {
        textarea.value = '';
        autoGrow();
        updateCharCount();
        // Add success animation to feedback
        const feedback = document.getElementById('feedback');
        if (feedback) {
          feedback.classList.add('success-flash');
          setTimeout(() => feedback.classList.remove('success-flash'), 600);
        }
      }
    }
  });

  // Disable buttons during request
  document.body.addEventListener('htmx:beforeRequest', (event) => {
    const target = event.detail.elt as HTMLButtonElement;
    if (target) {
      target.disabled = true;
    }
  });

  document.body.addEventListener('htmx:afterRequest', (event) => {
    const target = event.detail.elt as HTMLButtonElement;
    if (target) {
      target.disabled = false;
    }
  });
</script>
