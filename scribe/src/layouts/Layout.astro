---
import { getTheme, themeToCssVars } from '../lib/themes';

interface Props {
  title: string;
}

const { title } = Astro.props;
const currentPath = Astro.url.pathname;

const GARDENER_URL =
  process.env.GARDENER_URL ||
  import.meta.env.GARDENER_URL ||
  'http://localhost:8000';
const AUTH_TOKEN =
  process.env.ATHENA_AUTH_TOKEN ||
  import.meta.env.ATHENA_AUTH_TOKEN ||
  '';
const authHeaders = AUTH_TOKEN
  ? { Authorization: `Bearer ${AUTH_TOKEN}`, 'X-Auth-Token': AUTH_TOKEN }
  : {};

const defaultBranding = {
  app_name: 'Athena Scribe',
  icon_version: 'default',
  theme: 'default',
};

let branding = { ...defaultBranding };
try {
  const response = await fetch(`${GARDENER_URL}/api/branding`, {
    headers: authHeaders,
  });
  if (response.ok) {
    branding = { ...branding, ...(await response.json()) };
  }
} catch (error) {
  console.warn('Failed to load branding settings', error);
}

const appName = branding.app_name || defaultBranding.app_name;
const iconVersion = branding.icon_version || defaultBranding.icon_version;
const iconQuery = iconVersion ? `?v=${iconVersion}` : '';
const theme = getTheme(branding.theme);
const themeStyle = themeToCssVars(theme);
---

<!doctype html>
<html lang="en" data-theme={theme.id} style={themeStyle}>
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="manifest" href={`/manifest.webmanifest${iconQuery}`} />
    <link rel="icon" href="/favicon.ico" sizes="any" />
    <link rel="icon" href="/icon.svg" type="image/svg+xml" />
    <link rel="icon" type="image/png" sizes="32x32" href={`/icons/favicon-32.png${iconQuery}`} />
    <link rel="icon" type="image/png" sizes="16x16" href={`/icons/favicon-16.png${iconQuery}`} />
    <link rel="apple-touch-icon" sizes="180x180" href={`/icons/apple-touch-icon-180.png${iconQuery}`} />
    <link rel="apple-touch-icon" sizes="167x167" href={`/icons/apple-touch-icon-167.png${iconQuery}`} />
    <link rel="apple-touch-icon" sizes="152x152" href={`/icons/apple-touch-icon-152.png${iconQuery}`} />
    <link rel="apple-touch-icon" sizes="120x120" href={`/icons/apple-touch-icon-120.png${iconQuery}`} />
    <meta name="theme-color" content={theme.themeColor} />
    <meta name="application-name" content={appName} />
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-title" content={appName} />
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
    <meta name="mobile-web-app-capable" content="yes" />
    <title>{title}</title>
    <script src="https://unpkg.com/htmx.org@2.0.4"></script>
    <style is:global>
      :root {
        --color-bg: #0b1120;
        --color-surface: #111827;
        --color-surface-alt: #1f2937;
        --color-surface-muted: #0f172a;
        --color-border: #1f2937;
        --color-text: #f3f4f6;
        --color-text-muted: #9ca3af;
        --color-text-subtle: #6b7280;
        --accent-rgb: 59 130 246;
        --accent-hover: #2563eb;
        --accent-contrast: #f8fafc;
        --focus-rgb: 56 189 248;
        --danger-rgb: 248 113 113;
        --warning-rgb: 251 191 36;
        --success-rgb: 52 211 153;
        --category-1-rgb: 96 165 250;
        --category-2-rgb: 167 139 250;
        --category-3-rgb: 74 222 128;
        --category-4-rgb: 34 211 238;
        --category-5-rgb: 251 191 36;
        --category-6-rgb: 244 114 182;
        --category-7-rgb: 251 146 60;
        --category-8-rgb: 94 234 212;
        --accent: rgb(var(--accent-rgb) / 1);
        --accent-soft: rgb(var(--accent-rgb) / 0.18);
        --focus: rgb(var(--focus-rgb) / 1);
        --danger: rgb(var(--danger-rgb) / 1);
        --danger-soft: rgb(var(--danger-rgb) / 0.18);
        --danger-border: rgb(var(--danger-rgb) / 0.35);
        --success: rgb(var(--success-rgb) / 1);
        --warning: rgb(var(--warning-rgb) / 1);
      }

      .bg-app {
        background-color: var(--color-bg);
      }

      .bg-surface {
        background-color: var(--color-surface);
      }

      .bg-surface-alt {
        background-color: var(--color-surface-alt);
      }

      .bg-surface-muted {
        background-color: var(--color-surface-muted);
      }

      .text-primary {
        color: var(--color-text);
      }

      .text-muted {
        color: var(--color-text-muted);
      }

      .text-subtle {
        color: var(--color-text-subtle);
      }

      .border-default {
        border-color: var(--color-border);
      }

      .link {
        color: var(--accent);
      }

      .link:hover {
        color: var(--accent-hover);
      }

      .btn-primary {
        background-color: var(--accent);
        color: var(--accent-contrast);
      }

      .btn-primary:hover {
        background-color: var(--accent-hover);
      }

      .btn-secondary {
        background-color: var(--color-surface-alt);
        border: 1px solid var(--color-border);
        color: var(--color-text-muted);
      }

      .btn-secondary:hover {
        background-color: var(--color-surface);
        color: var(--color-text);
      }

      .panel {
        background-color: var(--color-surface);
        border: 1px solid var(--color-border);
        border-radius: 0.75rem;
      }

      .theme-option {
        background-color: var(--color-surface);
        border: 1px solid var(--color-border);
        border-radius: 0.75rem;
        cursor: pointer;
        padding: 0.75rem 1rem;
        transition: border-color var(--transition-fast) var(--ease-in-out),
          box-shadow var(--transition-fast) var(--ease-in-out),
          transform var(--transition-fast) var(--ease-in-out);
      }

      .theme-option:hover {
        border-color: var(--accent);
        transform: translateY(-1px);
      }

      .theme-option-selected {
        border-color: var(--accent);
        box-shadow: 0 0 0 1px rgb(var(--accent-rgb) / 0.4);
      }

      .input-field {
        background-color: var(--color-surface-muted);
        border: 1px solid var(--color-border);
        color: var(--color-text);
        outline: none;
      }

      .input-field::placeholder {
        color: var(--color-text-subtle);
      }

      .input-field:focus {
        border-color: var(--focus);
        box-shadow: 0 0 0 1px rgb(var(--focus-rgb) / 0.6);
      }

      /* Prevent iOS Safari auto-zoom on input focus by ensuring 16px minimum */
      @media (max-width: 768px) {
        input,
        textarea,
        select {
          font-size: 16px;
        }
      }

      .text-success {
        color: var(--success);
      }

      .text-warning {
        color: var(--warning);
      }

      .text-danger {
        color: var(--danger);
      }

      .bg-danger-soft {
        background-color: var(--danger-soft);
      }

      .border-danger {
        border-color: var(--danger-border);
      }

      .category-1 { --category-rgb: var(--category-1-rgb); }
      .category-2 { --category-rgb: var(--category-2-rgb); }
      .category-3 { --category-rgb: var(--category-3-rgb); }
      .category-4 { --category-rgb: var(--category-4-rgb); }
      .category-5 { --category-rgb: var(--category-5-rgb); }
      .category-6 { --category-rgb: var(--category-6-rgb); }
      .category-7 { --category-rgb: var(--category-7-rgb); }
      .category-8 { --category-rgb: var(--category-8-rgb); }

      .category-chip {
        border: 1px solid rgb(var(--category-rgb) / 0.35);
        background-color: rgb(var(--category-rgb) / 0.18);
        color: rgb(var(--category-rgb));
      }

      .category-chip:hover {
        background-color: rgb(var(--category-rgb) / 0.28);
      }

      .category-text {
        color: rgb(var(--category-rgb));
      }

      .prose-theme {
        --tw-prose-body: var(--color-text-muted);
        --tw-prose-headings: var(--color-text);
        --tw-prose-links: var(--accent);
        --tw-prose-bold: var(--color-text);
        --tw-prose-counters: var(--color-text-subtle);
        --tw-prose-bullets: var(--color-text-subtle);
        --tw-prose-hr: var(--color-border);
        --tw-prose-quotes: var(--color-text);
        --tw-prose-quote-borders: var(--color-border);
        --tw-prose-captions: var(--color-text-subtle);
        --tw-prose-code: var(--accent);
        --tw-prose-pre-code: var(--color-text);
        --tw-prose-pre-bg: var(--color-surface-alt);
        --tw-prose-th-borders: var(--color-border);
        --tw-prose-td-borders: var(--color-border);
      }

      kbd {
        background-color: var(--color-surface-alt);
        border: 1px solid var(--color-border);
        color: var(--color-text-muted);
      }

      input[type='file']::file-selector-button {
        background-color: var(--color-surface-alt);
        color: var(--color-text);
        border: none;
        transition: background-color var(--transition-fast) var(--ease-in-out);
      }

      input[type='file']::file-selector-button:hover {
        background-color: var(--color-surface);
      }
      /* Global animation variables */
      :root {
        --transition-fast: 150ms;
        --transition-base: 200ms;
        --transition-slow: 300ms;
        --ease-in-out: cubic-bezier(0.4, 0, 0.2, 1);
        --ease-out: cubic-bezier(0, 0, 0.2, 1);
        --ease-in: cubic-bezier(0.4, 0, 1, 1);
      }

      /* Respect prefers-reduced-motion */
      @media (prefers-reduced-motion: reduce) {
        *,
        *::before,
        *::after {
          animation-duration: 0.01ms !important;
          animation-iteration-count: 1 !important;
          transition-duration: 0.01ms !important;
        }
      }

      /* Page fade-in animation */
      @keyframes fadeIn {
        from {
          opacity: 0;
          transform: translateY(8px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      body {
        animation: fadeIn var(--transition-slow) var(--ease-out);
      }

      /* Smooth hover effects for interactive elements */
      a, button {
        transition: all var(--transition-fast) var(--ease-in-out);
      }

      /* Enhanced button hover with subtle scale */
      button:not(:disabled):hover {
        transform: translateY(-1px);
      }

      button:not(:disabled):active {
        transform: translateY(0);
      }

      /* Modal animations */
      @keyframes fadeIn {
        from { opacity: 0; }
        to { opacity: 1; }
      }

      @keyframes slideUp {
        from {
          opacity: 0;
          transform: translateY(16px) scale(0.98);
        }
        to {
          opacity: 1;
          transform: translateY(0) scale(1);
        }
      }

      .animate-fadeIn {
        animation: fadeIn var(--transition-base) var(--ease-out);
      }

      .animate-slideUp {
        animation: slideUp var(--transition-slow) var(--ease-out);
      }

      /* Stagger animation for lists */
      @keyframes staggerFadeIn {
        from {
          opacity: 0;
          transform: translateY(4px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      /* Apply stagger to list items */
      .stagger-item {
        animation: staggerFadeIn var(--transition-base) var(--ease-out);
      }

      .stagger-item:nth-child(1) { animation-delay: 0ms; }
      .stagger-item:nth-child(2) { animation-delay: 50ms; }
      .stagger-item:nth-child(3) { animation-delay: 100ms; }
      .stagger-item:nth-child(4) { animation-delay: 150ms; }
      .stagger-item:nth-child(5) { animation-delay: 200ms; }
      .stagger-item:nth-child(6) { animation-delay: 250ms; }
      .stagger-item:nth-child(7) { animation-delay: 300ms; }
      .stagger-item:nth-child(8) { animation-delay: 350ms; }
      .stagger-item:nth-child(9) { animation-delay: 400ms; }
      .stagger-item:nth-child(10) { animation-delay: 450ms; }

      /* Mobile bottom nav spacing */
      @media (max-width: 768px) {
        body {
          padding-bottom: 4rem; /* 64px for nav bar */
        }
      }
    </style>
  </head>
  <body class="min-h-screen bg-app text-primary">
    <slot />

    <!-- Keyboard Shortcuts Help Modal -->
    <div id="shortcuts-modal" class="hidden fixed inset-0 bg-black/70 backdrop-blur-sm z-50 flex items-center justify-center p-4 animate-fadeIn">
      <div class="panel max-w-2xl w-full max-h-[80vh] overflow-auto animate-slideUp">
        <div class="sticky top-0 bg-surface border-b border-default p-4 flex items-center justify-between">
          <h2 class="text-xl font-light text-primary">Keyboard Shortcuts</h2>
          <button id="close-shortcuts" class="text-muted hover:text-primary text-2xl leading-none">&times;</button>
        </div>

        <div class="p-6 space-y-6">
          <!-- Global Shortcuts -->
          <section>
            <h3 class="text-sm font-semibold text-muted uppercase mb-3">Global</h3>
            <div class="space-y-2">
              <div class="flex items-center justify-between">
                <span class="text-primary">Show this help</span>
                <kbd class="px-2 py-1 rounded text-sm">?</kbd>
              </div>
              <div class="flex items-center justify-between">
                <span class="text-primary">Close modal / Clear textarea</span>
                <kbd class="px-2 py-1 rounded text-sm">Esc</kbd>
              </div>
            </div>
          </section>

          <!-- Navigation Shortcuts -->
          <section>
            <h3 class="text-sm font-semibold text-muted uppercase mb-3">Navigation</h3>
            <div class="space-y-2">
              <div class="flex items-center justify-between">
                <span class="text-primary">Go to Capture</span>
                <div class="flex gap-1">
                  <kbd class="px-2 py-1 rounded text-sm">g</kbd>
                  <span class="text-subtle">then</span>
                  <kbd class="px-2 py-1 rounded text-sm">c</kbd>
                </div>
              </div>
              <div class="flex items-center justify-between">
                <span class="text-primary">Go to Browse</span>
                <div class="flex gap-1">
                  <kbd class="px-2 py-1 rounded text-sm">g</kbd>
                  <span class="text-subtle">then</span>
                  <kbd class="px-2 py-1 rounded text-sm">b</kbd>
                </div>
              </div>
              <div class="flex items-center justify-between">
                <span class="text-primary">Go to Archive</span>
                <div class="flex gap-1">
                  <kbd class="px-2 py-1 rounded text-sm">g</kbd>
                  <span class="text-subtle">then</span>
                  <kbd class="px-2 py-1 rounded text-sm">a</kbd>
                </div>
              </div>
            </div>
          </section>

          <!-- Capture Page Shortcuts -->
          <section>
            <h3 class="text-sm font-semibold text-muted uppercase mb-3">Capture Page</h3>
            <div class="space-y-2">
              <div class="flex items-center justify-between">
                <span class="text-primary">Submit note</span>
                <kbd class="px-2 py-1 rounded text-sm">Ctrl/Cmd + Enter</kbd>
              </div>
              <div class="flex items-center justify-between">
                <span class="text-primary">Refine note</span>
                <kbd class="px-2 py-1 rounded text-sm">Ctrl/Cmd + R</kbd>
              </div>
              <div class="flex items-center justify-between">
                <span class="text-primary">Explore / Ask</span>
                <kbd class="px-2 py-1 rounded text-sm">Ctrl/Cmd + E</kbd>
              </div>
              <div class="flex items-center justify-between">
                <span class="text-primary">Clear textarea</span>
                <kbd class="px-2 py-1 rounded text-sm">Ctrl/Cmd + K</kbd>
              </div>
            </div>
          </section>
        </div>

        <div class="sticky bottom-0 bg-surface border-t border-default p-4 text-center text-sm text-muted">
          Press <kbd class="px-1.5 py-0.5 rounded text-xs">Esc</kbd> to close
        </div>
      </div>
    </div>

    <!-- Footer hint -->
    <div class="fixed bottom-4 right-4 text-xs text-subtle">
      Press <kbd class="px-1.5 py-0.5 rounded">?</kbd> for shortcuts
    </div>

    <script>
      // Keyboard shortcuts system
      let gPressed = false;
      let gPressedTimeout: number | null = null;

      // Check if user is typing in an input/textarea
      function isTyping() {
        const activeElement = document.activeElement;
        return (
          activeElement instanceof HTMLInputElement ||
          activeElement instanceof HTMLTextAreaElement ||
          activeElement instanceof HTMLElement && activeElement.isContentEditable
        );
      }

      // Show/hide shortcuts modal
      function toggleShortcutsModal() {
        const modal = document.getElementById('shortcuts-modal');
        if (modal) {
          modal.classList.toggle('hidden');
        }
      }

      function hideShortcutsModal() {
        const modal = document.getElementById('shortcuts-modal');
        if (modal) {
          modal.classList.add('hidden');
        }
      }

      // Global keyboard handler
      document.addEventListener('keydown', (e) => {
        // Handle Escape key
        if (e.key === 'Escape') {
          // Close modal if open
          const modal = document.getElementById('shortcuts-modal');
          if (modal && !modal.classList.contains('hidden')) {
            hideShortcutsModal();
            return;
          }

          // Clear textarea if on capture page
          const textarea = document.getElementById('note-input') as HTMLTextAreaElement;
          if (textarea && document.activeElement === textarea) {
            textarea.value = '';
            e.preventDefault();
          }
          return;
        }

        // Show shortcuts modal on ?
        if (e.key === '?' && !isTyping()) {
          toggleShortcutsModal();
          e.preventDefault();
          return;
        }

        // "g" sequence navigation (Gmail-style)
        if (e.key === 'g' && !isTyping() && !e.ctrlKey && !e.metaKey) {
          gPressed = true;
          if (gPressedTimeout) clearTimeout(gPressedTimeout);
          gPressedTimeout = setTimeout(() => {
            gPressed = false;
          }, 1000);
          return;
        }

        if (gPressed && !isTyping()) {
          let targetUrl = '';
          if (e.key === 'c') targetUrl = '/';
          else if (e.key === 'b') targetUrl = '/browse';
          else if (e.key === 'a') targetUrl = '/archive';

          if (targetUrl) {
            window.location.href = targetUrl;
            gPressed = false;
            e.preventDefault();
            return;
          }
        }

        // Capture page shortcuts (Ctrl/Cmd + key)
        if ((e.ctrlKey || e.metaKey) && !e.shiftKey && !e.altKey) {
          // Submit note: Ctrl/Cmd + Enter
          if (e.key === 'Enter') {
            const submitBtn = document.getElementById('submit-btn') as HTMLButtonElement;
            if (submitBtn) {
              submitBtn.click();
              e.preventDefault();
            }
            return;
          }

          // Refine: Ctrl/Cmd + R
          if (e.key === 'r') {
            const refineBtn = document.getElementById('refine-btn') as HTMLButtonElement;
            if (refineBtn) {
              refineBtn.click();
              e.preventDefault();
            }
            return;
          }

          // Explore/Ask: Ctrl/Cmd + E
          if (e.key === 'e') {
            const askBtn = document.getElementById('ask-btn') as HTMLButtonElement;
            if (askBtn) {
              askBtn.click();
              e.preventDefault();
            }
            return;
          }

          // Clear textarea: Ctrl/Cmd + K
          if (e.key === 'k') {
            const textarea = document.getElementById('note-input') as HTMLTextAreaElement;
            if (textarea) {
              textarea.value = '';
              textarea.focus();
              e.preventDefault();
            }
            return;
          }
        }
      });

      // Close modal on button click
      document.getElementById('close-shortcuts')?.addEventListener('click', hideShortcutsModal);

      // Close modal on outside click
      document.getElementById('shortcuts-modal')?.addEventListener('click', (e) => {
        if (e.target === e.currentTarget) {
          hideShortcutsModal();
        }
      });

    </script>

    <!-- Mobile Bottom Navigation (PWA) -->
    <nav class="md:hidden fixed bottom-0 left-0 right-0 bg-surface border-t border-default z-40 safe-area-bottom">
      <div class="flex items-center justify-around h-16">
        <a
          href="/"
          class={`flex flex-col items-center justify-center flex-1 h-full transition-colors ${currentPath === '/' ? 'text-accent' : 'text-muted hover:text-primary'}`}
        >
          <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
          </svg>
          <span class="text-xs mt-1">Capture</span>
        </a>
        <a
          href="/browse"
          class={`flex flex-col items-center justify-center flex-1 h-full transition-colors ${currentPath.startsWith('/browse') ? 'text-accent' : 'text-muted hover:text-primary'}`}
        >
          <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 7v10a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-6l-2-2H5a2 2 0 00-2 2z" />
          </svg>
          <span class="text-xs mt-1">Browse</span>
        </a>
        <a
          href="/archive"
          class={`flex flex-col items-center justify-center flex-1 h-full transition-colors ${currentPath.startsWith('/archive') ? 'text-accent' : 'text-muted hover:text-primary'}`}
        >
          <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 8h14M5 8a2 2 0 110-4h14a2 2 0 110 4M5 8v10a2 2 0 002 2h10a2 2 0 002-2V8m-9 4h4" />
          </svg>
          <span class="text-xs mt-1">Archive</span>
        </a>
        <a
          href="/settings"
          class={`flex flex-col items-center justify-center flex-1 h-full transition-colors ${currentPath === '/settings' ? 'text-accent' : 'text-muted hover:text-primary'}`}
        >
          <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" />
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
          </svg>
          <span class="text-xs mt-1">Settings</span>
        </a>
      </div>
    </nav>

    <style>
      /* iOS safe area support for bottom nav */
      .safe-area-bottom {
        padding-bottom: env(safe-area-inset-bottom);
      }
    </style>
  </body>
</html>
