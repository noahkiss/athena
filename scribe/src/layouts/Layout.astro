---
import { getTheme, themeToCssVars, themes } from '../lib/themes';
import { getHeaderFont, getBodyFont, getMonoFont, getFontFamily } from '../lib/fonts';
import '../styles/fonts.css';

interface Props {
  title: string;
}

const { title } = Astro.props;
const currentPath = Astro.url.pathname;

const GARDENER_URL =
  process.env.GARDENER_URL ||
  import.meta.env.GARDENER_URL ||
  'http://localhost:8000';
const AUTH_TOKEN =
  process.env.ATHENA_AUTH_TOKEN ||
  import.meta.env.ATHENA_AUTH_TOKEN ||
  '';
const authHeaders = AUTH_TOKEN
  ? { Authorization: `Bearer ${AUTH_TOKEN}`, 'X-Auth-Token': AUTH_TOKEN }
  : {};

const defaultBranding = {
  app_name: 'Athena Scribe',
  icon_version: 'default',
  theme: 'default',
  font_header: 'inter',
  font_body: 'inter',
  font_mono: 'fira-code',
};

let branding = { ...defaultBranding };
try {
  const response = await fetch(`${GARDENER_URL}/api/branding`, {
    headers: authHeaders,
  });
  if (response.ok) {
    branding = { ...branding, ...(await response.json()) };
  }
} catch (error) {
  console.warn('Failed to load branding settings', error);
}

const appName = branding.app_name || defaultBranding.app_name;
const iconVersion = branding.icon_version || defaultBranding.icon_version;
const iconQuery = iconVersion ? `?v=${iconVersion}` : '';
const theme = getTheme(branding.theme);
const themeStyle = themeToCssVars(theme);
const headerFont = getHeaderFont(branding.font_header);
const bodyFont = getBodyFont(branding.font_body);
const monoFont = getMonoFont(branding.font_mono);

// Prepare theme data for client-side color scheme detection
const lightTheme = themes['rose-pine-dawn'];
const darkTheme = themes['catppuccin-mocha'];
const lightThemeVars = themeToCssVars(lightTheme);
const darkThemeVars = themeToCssVars(darkTheme);
---

<!doctype html>
<html lang="en" data-theme={theme.id} data-font-header={headerFont.id} data-font-body={bodyFont.id} data-font-mono={monoFont.id} style={`${themeStyle} --font-family-header: ${getFontFamily(headerFont)}; --font-family-body: ${getFontFamily(bodyFont)}; --font-family-mono: ${getFontFamily(monoFont)};`}>
  <head>
    <meta charset="UTF-8" />
    <!-- Blocking script to prevent theme flash -->
    <script is:inline define:vars={{
      lightThemeVars,
      darkThemeVars,
      serverThemeId: theme.id,
      serverHeaderFontFamily: getFontFamily(headerFont),
      serverBodyFontFamily: getFontFamily(bodyFont),
      serverMonoFontFamily: getFontFamily(monoFont)
    }}>
      (function() {
        const html = document.documentElement;

        function applyTheme(themeVarsString, themeId) {
          const pairs = themeVarsString.split(';').filter(Boolean);
          pairs.forEach(pair => {
            const [key, value] = pair.split(':').map(s => s.trim());
            if (key && value) {
              html.style.setProperty(key, value);
            }
          });
          html.setAttribute('data-theme', themeId);
        }

        function applyFonts(headerFamily, bodyFamily, monoFamily, headerFontId, bodyFontId, monoFontId) {
          html.style.setProperty('--font-family-header', headerFamily);
          html.style.setProperty('--font-family-body', bodyFamily);
          html.style.setProperty('--font-family-mono', monoFamily);
          html.setAttribute('data-font-header', headerFontId);
          html.setAttribute('data-font-body', bodyFontId);
          html.setAttribute('data-font-mono', monoFontId);
        }

        // Check localStorage first (faster than API)
        const savedTheme = localStorage.getItem('athena-theme');
        const savedHeaderFont = localStorage.getItem('athena-font-header');
        const savedBodyFont = localStorage.getItem('athena-font-body');
        const savedMonoFont = localStorage.getItem('athena-font-mono');
        const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;

        // Apply saved fonts if available (use server fonts as fallback)
        const headerFontId = savedHeaderFont || 'inter';
        const bodyFontId = savedBodyFont || 'inter';
        const monoFontId = savedMonoFont || 'fira-code';

        if (savedHeaderFont || savedBodyFont || savedMonoFont) {
          // Font families for each font option (synced with fonts.ts)
          const headerFonts = {
            'inter': '"Inter Variable", Inter, sans-serif',
            'roboto-flex': '"Roboto Flex", Roboto, sans-serif',
            'rubik': 'Rubik, sans-serif',
            'atkinson-hyperlegible': '"Atkinson Hyperlegible", sans-serif',
            'eb-garamond': '"EB Garamond", serif',
            'fraunces': '"Fraunces Variable", Fraunces, serif'
          };
          const bodyFonts = {
            'inter': '"Inter Variable", Inter, sans-serif',
            'atkinson-hyperlegible': '"Atkinson Hyperlegible", sans-serif',
            'source-sans-3': '"Source Sans 3", sans-serif',
            'noto-sans': '"Noto Sans Variable", "Noto Sans", sans-serif',
            'literata': 'Literata, serif',
            'ibm-plex-sans': '"IBM Plex Sans", sans-serif'
          };
          const monoFonts = {
            'fira-code': '"Fira Code Variable", "Fira Code", monospace',
            'jetbrains-mono': '"JetBrains Mono", monospace',
            'source-code-pro': '"Source Code Pro Variable", "Source Code Pro", monospace',
            'ibm-plex-mono': '"IBM Plex Mono", monospace',
            'cascadia-code': '"Cascadia Code", monospace',
            'system-mono': 'ui-monospace, "SF Mono", Monaco, "Cascadia Code", "Roboto Mono", Consolas, monospace'
          };

          const headerFamily = headerFonts[headerFontId] || serverHeaderFontFamily;
          const bodyFamily = bodyFonts[bodyFontId] || serverBodyFontFamily;
          const monoFamily = monoFonts[monoFontId] || serverMonoFontFamily;

          applyFonts(headerFamily, bodyFamily, monoFamily, headerFontId, bodyFontId, monoFontId);
        }

        // If server says "default" or we have localStorage override
        if (serverThemeId === 'default' || (savedTheme && savedTheme !== serverThemeId)) {
          const themeToUse = savedTheme && savedTheme !== 'default' ? savedTheme : (prefersDark ? 'catppuccin-mocha' : 'rose-pine-dawn');

          if (themeToUse === 'catppuccin-mocha') {
            applyTheme(darkThemeVars, 'catppuccin-mocha');
            localStorage.setItem('athena-theme', 'catppuccin-mocha');
            html.setAttribute('data-auto-theme', 'true');
          } else if (themeToUse === 'rose-pine-dawn') {
            applyTheme(lightThemeVars, 'rose-pine-dawn');
            localStorage.setItem('athena-theme', 'rose-pine-dawn');
            html.setAttribute('data-auto-theme', 'true');
          }
        }
      })();
    </script>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="manifest" href={`/manifest.webmanifest${iconQuery}`} />
    <link rel="icon" href="/favicon.ico" sizes="any" />
    <link rel="icon" href="/icon.svg" type="image/svg+xml" />
    <link rel="icon" type="image/png" sizes="32x32" href={`/icons/favicon-32.png${iconQuery}`} />
    <link rel="icon" type="image/png" sizes="16x16" href={`/icons/favicon-16.png${iconQuery}`} />
    <link rel="apple-touch-icon" sizes="180x180" href={`/icons/apple-touch-icon-180.png${iconQuery}`} />
    <link rel="apple-touch-icon" sizes="167x167" href={`/icons/apple-touch-icon-167.png${iconQuery}`} />
    <link rel="apple-touch-icon" sizes="152x152" href={`/icons/apple-touch-icon-152.png${iconQuery}`} />
    <link rel="apple-touch-icon" sizes="120x120" href={`/icons/apple-touch-icon-120.png${iconQuery}`} />
    <meta name="theme-color" content={theme.themeColor} />
    <meta name="application-name" content={appName} />
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-title" content={appName} />
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
    <meta name="mobile-web-app-capable" content="yes" />
    <title>{title}</title>
    <script src="https://unpkg.com/htmx.org@2.0.4"></script>
    <style is:global>
      :root {
        /* Color variables */
        --color-bg: #0b1120;
        --color-surface: #111827;
        --color-surface-alt: #1f2937;
        --color-surface-muted: #0f172a;
        --color-border: #1f2937;
        --color-text: #f3f4f6;
        --color-text-muted: #9ca3af;
        --color-text-subtle: #6b7280;
        --accent-rgb: 59 130 246;
        --accent-hover: #2563eb;
        --accent-contrast: #f8fafc;
        --focus-rgb: 56 189 248;
        --danger-rgb: 248 113 113;
        --warning-rgb: 251 191 36;
        --success-rgb: 52 211 153;
        --category-1-rgb: 96 165 250;
        --category-2-rgb: 167 139 250;
        --category-3-rgb: 74 222 128;
        --category-4-rgb: 34 211 238;
        --category-5-rgb: 251 191 36;
        --category-6-rgb: 244 114 182;
        --category-7-rgb: 251 146 60;
        --category-8-rgb: 94 234 212;
        --accent: rgb(var(--accent-rgb) / 1);
        --accent-soft: rgb(var(--accent-rgb) / 0.18);
        --focus: rgb(var(--focus-rgb) / 1);
        --danger: rgb(var(--danger-rgb) / 1);
        --danger-soft: rgb(var(--danger-rgb) / 0.18);
        --danger-border: rgb(var(--danger-rgb) / 0.35);
        --success: rgb(var(--success-rgb) / 1);
        --warning: rgb(var(--warning-rgb) / 1);

        /* iOS spacing guidelines */
        --spacing-page: 16px;        /* Mobile page margins */
        --spacing-section: 24px;      /* Section spacing */
        --spacing-card: 16px;         /* Card internal padding */
        --spacing-element: 12px;      /* Element spacing */

        /* Typography scale (iOS-inspired) */
        --font-size-xs: 0.75rem;      /* 12px - captions */
        --font-size-sm: 0.875rem;     /* 14px - body small */
        --font-size-base: 1rem;       /* 16px - body */
        --font-size-lg: 1.125rem;     /* 18px - subheadings */
        --font-size-xl: 1.25rem;      /* 20px - headings */
        --font-size-2xl: 1.5rem;      /* 24px - large headings */
        --font-size-3xl: 1.875rem;    /* 30px - hero */

        /* Line heights */
        --line-height-tight: 1.25;
        --line-height-normal: 1.5;
        --line-height-relaxed: 1.75;

        /* Font weights */
        --font-weight-normal: 400;
        --font-weight-medium: 500;
        --font-weight-semibold: 600;
        --font-weight-bold: 700;

        /* Touch targets */
        --touch-target-min: 44px;     /* iOS minimum touch target */
      }

      /* Tablet and larger spacing */
      @media (min-width: 768px) {
        :root {
          --spacing-page: 24px;
          --spacing-section: 32px;
          --spacing-card: 24px;
        }
      }

      :root {
        /* Default font families - can be overridden by branding settings */
        --font-family-header: "Inter Variable", Inter, -apple-system, BlinkMacSystemFont, sans-serif;
        --font-family-body: "Inter Variable", Inter, -apple-system, BlinkMacSystemFont, sans-serif;
        --font-family-mono: "Fira Code Variable", "Fira Code", ui-monospace, monospace;
      }

      /* Apply font families from CSS variables */
      * {
        font-family: var(--font-family-body);
        -webkit-font-smoothing: antialiased;
        -moz-osx-font-smoothing: grayscale;
      }

      /* Header fonts */
      h1, h2, h3, h4, h5, h6,
      .page-title {
        font-family: var(--font-family-header);
      }

      /* Monospace fonts */
      code, pre, kbd, samp,
      .font-mono, .editor, textarea[name="content"] {
        font-family: var(--font-family-mono);
      }

      .bg-app {
        background-color: var(--color-bg);
      }

      .bg-surface {
        background-color: var(--color-surface);
      }

      .bg-surface-alt {
        background-color: var(--color-surface-alt);
      }

      .bg-surface-muted {
        background-color: var(--color-surface-muted);
      }

      .text-primary {
        color: var(--color-text);
      }

      .text-muted {
        color: var(--color-text-muted);
      }

      .text-subtle {
        color: var(--color-text-subtle);
      }

      /* Typography utilities */
      h1, .text-3xl {
        font-size: var(--font-size-3xl);
        line-height: var(--line-height-tight);
        font-weight: var(--font-weight-semibold);
      }

      h2, .text-2xl {
        font-size: var(--font-size-2xl);
        line-height: var(--line-height-tight);
        font-weight: var(--font-weight-semibold);
      }

      h3, .text-xl {
        font-size: var(--font-size-xl);
        line-height: var(--line-height-normal);
        font-weight: var(--font-weight-medium);
      }

      h4, .text-lg {
        font-size: var(--font-size-lg);
        line-height: var(--line-height-normal);
        font-weight: var(--font-weight-medium);
      }

      p, .text-base {
        font-size: var(--font-size-base);
        line-height: var(--line-height-relaxed);
      }

      .text-sm {
        font-size: var(--font-size-sm);
        line-height: var(--line-height-normal);
      }

      .text-xs {
        font-size: var(--font-size-xs);
        line-height: var(--line-height-normal);
      }

      .border-default {
        border-color: var(--color-border);
      }

      .link {
        color: var(--accent);
      }

      .link:hover {
        color: var(--accent-hover);
      }

      .btn-primary {
        background-color: var(--accent);
        color: var(--accent-contrast);
        border-radius: 0.875rem;
        padding: 0.75rem 1.5rem;
        min-height: var(--touch-target-min);
        font-size: var(--font-size-base);
        font-weight: var(--font-weight-medium);
        line-height: var(--line-height-tight);
        box-shadow: 0 1px 3px 0 rgb(0 0 0 / 0.1), 0 1px 2px -1px rgb(0 0 0 / 0.1);
        transition: all var(--transition-fast) var(--ease-in-out);
      }

      .btn-primary:hover {
        background-color: var(--accent-hover);
        box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.15), 0 2px 4px -2px rgb(0 0 0 / 0.15);
        transform: translateY(-1px);
      }

      .btn-secondary {
        background-color: var(--color-surface-alt);
        border: 1px solid var(--color-border);
        color: var(--color-text-muted);
        border-radius: 0.875rem;
        padding: 0.75rem 1.5rem;
        min-height: var(--touch-target-min);
        font-size: var(--font-size-base);
        font-weight: var(--font-weight-medium);
        line-height: var(--line-height-tight);
        box-shadow: 0 1px 2px 0 rgb(0 0 0 / 0.05);
        transition: all var(--transition-fast) var(--ease-in-out);
      }

      .btn-secondary:hover {
        background-color: var(--color-surface);
        color: var(--color-text);
        box-shadow: 0 2px 4px 0 rgb(0 0 0 / 0.1);
        transform: translateY(-1px);
      }

      .panel {
        background-color: var(--color-surface);
        border: 1px solid var(--color-border);
        border-radius: 1rem;
        /* Surface elevation: subtle overlay for depth */
        background-image: linear-gradient(to bottom, rgb(255 255 255 / 0.02), rgb(0 0 0 / 0.02));
        box-shadow: 0 1px 3px 0 rgb(0 0 0 / 0.1), 0 1px 2px -1px rgb(0 0 0 / 0.1);
        transition: box-shadow var(--transition-fast) var(--ease-in-out),
                    transform var(--transition-fast) var(--ease-in-out);
      }

      .panel:hover {
        box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.15), 0 2px 4px -2px rgb(0 0 0 / 0.15);
        transform: translateY(-1px);
      }

      .theme-option {
        background-color: var(--color-surface);
        border: 1px solid var(--color-border);
        border-radius: 1rem;
        cursor: pointer;
        padding: 0.875rem 1.25rem;
        /* Surface elevation for interactive elements */
        background-image: linear-gradient(to bottom, rgb(255 255 255 / 0.03), rgb(0 0 0 / 0.01));
        transition: border-color var(--transition-fast) var(--ease-in-out),
          box-shadow var(--transition-fast) var(--ease-in-out),
          transform var(--transition-fast) var(--ease-in-out);
        box-shadow: 0 1px 2px 0 rgb(0 0 0 / 0.05);
      }

      .theme-option:hover {
        border-color: var(--accent);
        transform: translateY(-1px);
        box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
      }

      .theme-option-selected {
        border-color: var(--accent);
        box-shadow: 0 0 0 2px rgb(var(--accent-rgb) / 0.3), 0 1px 3px 0 rgb(0 0 0 / 0.1);
      }

      .input-field {
        background-color: var(--color-surface-muted);
        border: 1px solid var(--color-border);
        color: var(--color-text);
        outline: none;
        transition: border-color var(--transition-fast) var(--ease-in-out),
                    box-shadow var(--transition-fast) var(--ease-in-out),
                    background-color var(--transition-fast) var(--ease-in-out);
      }

      .input-field::placeholder {
        color: var(--color-text-subtle);
        transition: color var(--transition-fast) var(--ease-in-out);
      }

      .input-field:focus {
        border-color: var(--focus);
        box-shadow: 0 0 0 3px rgb(var(--focus-rgb) / 0.2), 0 0 16px rgb(var(--focus-rgb) / 0.15);
        background-color: var(--color-surface);
      }

      .input-field:focus::placeholder {
        color: var(--color-text-muted);
      }

      /* Auto-grow textarea support */
      .textarea-autogrow {
        resize: none;
        overflow: hidden;
        min-height: 120px;
        max-height: 60vh;
        transition: height var(--transition-fast) var(--ease-out),
                    border-color var(--transition-fast) var(--ease-in-out),
                    box-shadow var(--transition-fast) var(--ease-in-out);
      }

      /* Character counter */
      .char-counter {
        font-size: var(--font-size-xs);
        color: var(--color-text-subtle);
        transition: color var(--transition-fast) var(--ease-in-out);
      }

      .char-counter.warning {
        color: var(--warning);
      }

      .char-counter.danger {
        color: var(--danger);
      }

      /* Prevent iOS Safari auto-zoom on input focus by ensuring 16px minimum */
      @media (max-width: 768px) {
        input,
        textarea,
        select {
          font-size: 16px;
        }
      }

      .text-success {
        color: var(--success);
      }

      .text-warning {
        color: var(--warning);
      }

      .text-danger {
        color: var(--danger);
      }

      .bg-danger-soft {
        background-color: var(--danger-soft);
      }

      .border-danger {
        border-color: var(--danger-border);
      }

      .category-1 { --category-rgb: var(--category-1-rgb); }
      .category-2 { --category-rgb: var(--category-2-rgb); }
      .category-3 { --category-rgb: var(--category-3-rgb); }
      .category-4 { --category-rgb: var(--category-4-rgb); }
      .category-5 { --category-rgb: var(--category-5-rgb); }
      .category-6 { --category-rgb: var(--category-6-rgb); }
      .category-7 { --category-rgb: var(--category-7-rgb); }
      .category-8 { --category-rgb: var(--category-8-rgb); }

      .category-chip {
        border: 1px solid rgb(var(--category-rgb) / 0.35);
        background-color: rgb(var(--category-rgb) / 0.18);
        color: rgb(var(--category-rgb));
      }

      .category-chip:hover {
        background-color: rgb(var(--category-rgb) / 0.28);
      }

      .category-text {
        color: rgb(var(--category-rgb));
      }

      /* Page header styles - polished, consistent hierarchy */
      .page-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: var(--spacing-section);
        padding-bottom: var(--spacing-element);
        border-bottom: 1px solid rgb(var(--color-border) / 0.3);
      }

      .page-title {
        font-size: var(--font-size-3xl);
        font-weight: var(--font-weight-light);
        color: rgb(var(--color-primary));
        letter-spacing: -0.02em;
        margin: 0;
      }

      .page-nav {
        display: none;
        align-items: center;
        gap: 0.25rem;
      }

      @media (min-width: 768px) {
        .page-nav {
          display: flex;
        }
      }

      /* Enhanced navigation links */
      .nav-link {
        position: relative;
        padding: 0.5rem 0.875rem;
        font-size: var(--font-size-sm);
        font-weight: var(--font-weight-medium);
        color: rgb(var(--color-muted));
        text-decoration: none;
        border-radius: 0.5rem;
        transition: all 0.15s ease;
        letter-spacing: -0.01em;
      }

      .nav-link:hover {
        color: rgb(var(--color-primary));
        background-color: rgb(var(--color-surface-muted) / 0.5);
        transform: translateY(-1px);
      }

      .nav-link:active {
        transform: translateY(0);
      }

      /* Optional: Add subtle indicator for current page */
      .nav-link.active {
        color: rgb(var(--color-accent));
        background-color: rgb(var(--color-accent) / 0.1);
      }

      /* Button-like nav link variant */
      .nav-link-primary {
        color: rgb(var(--color-accent));
        font-weight: var(--font-weight-semibold);
      }

      .nav-link-primary:hover {
        color: rgb(var(--color-accent));
        background-color: rgb(var(--color-accent) / 0.15);
      }

      .prose-theme {
        --tw-prose-body: var(--color-text-muted);
        --tw-prose-headings: var(--color-text);
        --tw-prose-links: var(--accent);
        --tw-prose-bold: var(--color-text);
        --tw-prose-counters: var(--color-text-subtle);
        --tw-prose-bullets: var(--color-text-subtle);
        --tw-prose-hr: var(--color-border);
        --tw-prose-quotes: var(--color-text);
        --tw-prose-quote-borders: var(--color-border);
        --tw-prose-captions: var(--color-text-subtle);
        --tw-prose-code: var(--accent);
        --tw-prose-pre-code: var(--color-text);
        --tw-prose-pre-bg: var(--color-surface-alt);
        --tw-prose-th-borders: var(--color-border);
        --tw-prose-td-borders: var(--color-border);
      }

      kbd {
        background-color: var(--color-surface-alt);
        border: 1px solid var(--color-border);
        color: var(--color-text-muted);
      }

      input[type='file']::file-selector-button {
        background-color: var(--color-surface-alt);
        color: var(--color-text);
        border: none;
        transition: background-color var(--transition-fast) var(--ease-in-out);
      }

      input[type='file']::file-selector-button:hover {
        background-color: var(--color-surface);
      }
      /* Global animation variables */
      :root {
        --transition-fast: 150ms;
        --transition-base: 200ms;
        --transition-slow: 300ms;
        --ease-in-out: cubic-bezier(0.4, 0, 0.2, 1);
        --ease-out: cubic-bezier(0, 0, 0.2, 1);
        --ease-in: cubic-bezier(0.4, 0, 1, 1);
      }

      /* Respect prefers-reduced-motion */
      @media (prefers-reduced-motion: reduce) {
        *,
        *::before,
        *::after {
          animation-duration: 0.01ms !important;
          animation-iteration-count: 1 !important;
          transition-duration: 0.01ms !important;
        }
      }

      /* Page fade-in animation */
      @keyframes fadeIn {
        from {
          opacity: 0;
          transform: translateY(8px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      body {
        animation: fadeIn var(--transition-slow) var(--ease-out);
      }

      /* Smooth hover effects for interactive elements */
      a, button {
        transition: all var(--transition-fast) var(--ease-in-out);
      }

      /* Enhanced button hover with subtle scale */
      button:not(:disabled):hover {
        transform: translateY(-1px);
      }

      button:not(:disabled):active {
        transform: translateY(0) scale(0.98);
      }

      /* Ripple effect for buttons */
      .btn-ripple {
        position: relative;
        overflow: hidden;
      }

      .btn-ripple::after {
        content: '';
        position: absolute;
        width: 100%;
        height: 100%;
        top: 0;
        left: 0;
        pointer-events: none;
        background-image: radial-gradient(circle, rgb(255 255 255 / 0.25) 10%, transparent 10.01%);
        background-repeat: no-repeat;
        background-position: 50%;
        transform: scale(10, 10);
        opacity: 0;
        transition: transform 0.4s, opacity 0.8s;
      }

      .btn-ripple:active::after {
        transform: scale(0, 0);
        opacity: 0.3;
        transition: 0s;
      }

      /* Enhanced focus ring for all interactive elements */
      .focus-ring:focus-visible {
        outline: none;
        box-shadow: 0 0 0 2px var(--color-bg), 0 0 0 4px rgb(var(--focus-rgb) / 0.6);
      }

      /* Link hover underline animation */
      .link-animated {
        position: relative;
        text-decoration: none;
      }

      .link-animated::after {
        content: '';
        position: absolute;
        width: 100%;
        height: 1px;
        bottom: -2px;
        left: 0;
        background-color: currentColor;
        transform: scaleX(0);
        transform-origin: right;
        transition: transform var(--transition-fast) var(--ease-out);
      }

      .link-animated:hover::after {
        transform: scaleX(1);
        transform-origin: left;
      }

      /* Card hover lift effect */
      .card-interactive {
        transition: transform var(--transition-fast) var(--ease-out),
                    box-shadow var(--transition-fast) var(--ease-out);
      }

      .card-interactive:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 16px -4px rgb(0 0 0 / 0.2), 0 4px 8px -4px rgb(0 0 0 / 0.1);
      }

      .card-interactive:active {
        transform: translateY(0);
        box-shadow: 0 2px 4px -1px rgb(0 0 0 / 0.1);
      }

      /* Modal animations */
      @keyframes fadeIn {
        from { opacity: 0; }
        to { opacity: 1; }
      }

      @keyframes slideUp {
        from {
          opacity: 0;
          transform: translateY(16px) scale(0.98);
        }
        to {
          opacity: 1;
          transform: translateY(0) scale(1);
        }
      }

      .animate-fadeIn {
        animation: fadeIn var(--transition-base) var(--ease-out);
      }

      .animate-slideUp {
        animation: slideUp var(--transition-slow) var(--ease-out);
      }

      /* Stagger animation for lists */
      @keyframes staggerFadeIn {
        from {
          opacity: 0;
          transform: translateY(4px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      /* Apply stagger to list items */
      .stagger-item {
        animation: staggerFadeIn var(--transition-base) var(--ease-out);
      }

      .stagger-item:nth-child(1) { animation-delay: 0ms; }
      .stagger-item:nth-child(2) { animation-delay: 50ms; }
      .stagger-item:nth-child(3) { animation-delay: 100ms; }
      .stagger-item:nth-child(4) { animation-delay: 150ms; }
      .stagger-item:nth-child(5) { animation-delay: 200ms; }
      .stagger-item:nth-child(6) { animation-delay: 250ms; }
      .stagger-item:nth-child(7) { animation-delay: 300ms; }
      .stagger-item:nth-child(8) { animation-delay: 350ms; }
      .stagger-item:nth-child(9) { animation-delay: 400ms; }
      .stagger-item:nth-child(10) { animation-delay: 450ms; }

      /* Mobile bottom nav spacing */
      @media (max-width: 768px) {
        body {
          padding-bottom: 4rem; /* 64px for nav bar */
        }
      }
    </style>
  </head>
  <body class="min-h-screen bg-app text-primary">
    <slot />

    <!-- Keyboard Shortcuts Help Modal -->
    <div id="shortcuts-modal" class="hidden fixed inset-0 bg-black/70 backdrop-blur-sm z-50 flex items-center justify-center p-4 animate-fadeIn">
      <div class="panel max-w-2xl w-full max-h-[80vh] overflow-auto animate-slideUp">
        <div class="sticky top-0 bg-surface border-b border-default p-4 flex items-center justify-between">
          <h2 class="text-xl font-light text-primary">Keyboard Shortcuts</h2>
          <button id="close-shortcuts" class="text-muted hover:text-primary text-2xl leading-none">&times;</button>
        </div>

        <div class="p-6 space-y-6">
          <!-- Global Shortcuts -->
          <section>
            <h3 class="text-sm font-semibold text-muted uppercase mb-3">Global</h3>
            <div class="space-y-2">
              <div class="flex items-center justify-between">
                <span class="text-primary">Show this help</span>
                <kbd class="px-2 py-1 rounded text-sm">?</kbd>
              </div>
              <div class="flex items-center justify-between">
                <span class="text-primary">Close modal / Clear textarea</span>
                <kbd class="px-2 py-1 rounded text-sm">Esc</kbd>
              </div>
            </div>
          </section>

          <!-- Navigation Shortcuts -->
          <section>
            <h3 class="text-sm font-semibold text-muted uppercase mb-3">Navigation</h3>
            <div class="space-y-2">
              <div class="flex items-center justify-between">
                <span class="text-primary">Go to Capture</span>
                <div class="flex gap-1">
                  <kbd class="px-2 py-1 rounded text-sm">g</kbd>
                  <span class="text-subtle">then</span>
                  <kbd class="px-2 py-1 rounded text-sm">c</kbd>
                </div>
              </div>
              <div class="flex items-center justify-between">
                <span class="text-primary">Go to Browse</span>
                <div class="flex gap-1">
                  <kbd class="px-2 py-1 rounded text-sm">g</kbd>
                  <span class="text-subtle">then</span>
                  <kbd class="px-2 py-1 rounded text-sm">b</kbd>
                </div>
              </div>
              <div class="flex items-center justify-between">
                <span class="text-primary">Go to Archive</span>
                <div class="flex gap-1">
                  <kbd class="px-2 py-1 rounded text-sm">g</kbd>
                  <span class="text-subtle">then</span>
                  <kbd class="px-2 py-1 rounded text-sm">a</kbd>
                </div>
              </div>
            </div>
          </section>

          <!-- Capture Page Shortcuts -->
          <section>
            <h3 class="text-sm font-semibold text-muted uppercase mb-3">Capture Page</h3>
            <div class="space-y-2">
              <div class="flex items-center justify-between">
                <span class="text-primary">Submit note</span>
                <kbd class="px-2 py-1 rounded text-sm">Ctrl/Cmd + Enter</kbd>
              </div>
              <div class="flex items-center justify-between">
                <span class="text-primary">Refine note</span>
                <kbd class="px-2 py-1 rounded text-sm">Ctrl/Cmd + R</kbd>
              </div>
              <div class="flex items-center justify-between">
                <span class="text-primary">Explore / Ask</span>
                <kbd class="px-2 py-1 rounded text-sm">Ctrl/Cmd + E</kbd>
              </div>
              <div class="flex items-center justify-between">
                <span class="text-primary">Clear textarea</span>
                <kbd class="px-2 py-1 rounded text-sm">Ctrl/Cmd + K</kbd>
              </div>
            </div>
          </section>
        </div>

        <div class="sticky bottom-0 bg-surface border-t border-default p-4 text-center text-sm text-muted">
          Press <kbd class="px-1.5 py-0.5 rounded text-xs">Esc</kbd> to close
        </div>
      </div>
    </div>

    <!-- Footer hint -->
    <div class="fixed bottom-4 right-4 text-xs text-subtle">
      Press <kbd class="px-1.5 py-0.5 rounded">?</kbd> for shortcuts
    </div>

    <script is:inline define:vars={{ lightThemeVars, darkThemeVars }}>
      // Listen for OS color scheme changes and update auto-detected themes
      (function() {
        const html = document.documentElement;

        function applyTheme(themeVarsString, themeId) {
          const pairs = themeVarsString.split(';').filter(Boolean);
          pairs.forEach(pair => {
            const [key, value] = pair.split(':').map(s => s.trim());
            if (key && value) {
              html.style.setProperty(key, value);
            }
          });
          html.setAttribute('data-theme', themeId);
        }

        // Listen for color scheme changes (only for auto-detected themes)
        window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', (e) => {
          const isAutoTheme = html.getAttribute('data-auto-theme') === 'true';

          if (isAutoTheme) {
            const newTheme = e.matches ? 'catppuccin-mocha' : 'rose-pine-dawn';
            const newThemeVars = e.matches ? darkThemeVars : lightThemeVars;
            applyTheme(newThemeVars, newTheme);
            localStorage.setItem('athena-theme', newTheme);
          }
        });
      })();
    </script>

    <script>
      // Keyboard shortcuts system
      let gPressed = false;
      let gPressedTimeout: number | null = null;

      // Check if user is typing in an input/textarea
      function isTyping() {
        const activeElement = document.activeElement;
        return (
          activeElement instanceof HTMLInputElement ||
          activeElement instanceof HTMLTextAreaElement ||
          activeElement instanceof HTMLElement && activeElement.isContentEditable
        );
      }

      // Show/hide shortcuts modal
      function toggleShortcutsModal() {
        const modal = document.getElementById('shortcuts-modal');
        if (modal) {
          modal.classList.toggle('hidden');
        }
      }

      function hideShortcutsModal() {
        const modal = document.getElementById('shortcuts-modal');
        if (modal) {
          modal.classList.add('hidden');
        }
      }

      // Global keyboard handler
      document.addEventListener('keydown', (e) => {
        // Handle Escape key
        if (e.key === 'Escape') {
          // Close modal if open
          const modal = document.getElementById('shortcuts-modal');
          if (modal && !modal.classList.contains('hidden')) {
            hideShortcutsModal();
            return;
          }

          // Clear textarea if on capture page
          const textarea = document.getElementById('note-input') as HTMLTextAreaElement;
          if (textarea && document.activeElement === textarea) {
            textarea.value = '';
            e.preventDefault();
          }
          return;
        }

        // Show shortcuts modal on ?
        if (e.key === '?' && !isTyping()) {
          toggleShortcutsModal();
          e.preventDefault();
          return;
        }

        // "g" sequence navigation (Gmail-style)
        if (e.key === 'g' && !isTyping() && !e.ctrlKey && !e.metaKey) {
          gPressed = true;
          if (gPressedTimeout) clearTimeout(gPressedTimeout);
          gPressedTimeout = setTimeout(() => {
            gPressed = false;
          }, 1000);
          return;
        }

        if (gPressed && !isTyping()) {
          let targetUrl = '';
          if (e.key === 'c') targetUrl = '/';
          else if (e.key === 'b') targetUrl = '/browse';
          else if (e.key === 'a') targetUrl = '/archive';

          if (targetUrl) {
            window.location.href = targetUrl;
            gPressed = false;
            e.preventDefault();
            return;
          }
        }

        // Capture page shortcuts (Ctrl/Cmd + key)
        if ((e.ctrlKey || e.metaKey) && !e.shiftKey && !e.altKey) {
          // Submit note: Ctrl/Cmd + Enter
          if (e.key === 'Enter') {
            const submitBtn = document.getElementById('submit-btn') as HTMLButtonElement;
            if (submitBtn) {
              submitBtn.click();
              e.preventDefault();
            }
            return;
          }

          // Refine: Ctrl/Cmd + R
          if (e.key === 'r') {
            const refineBtn = document.getElementById('refine-btn') as HTMLButtonElement;
            if (refineBtn) {
              refineBtn.click();
              e.preventDefault();
            }
            return;
          }

          // Explore/Ask: Ctrl/Cmd + E
          if (e.key === 'e') {
            const askBtn = document.getElementById('ask-btn') as HTMLButtonElement;
            if (askBtn) {
              askBtn.click();
              e.preventDefault();
            }
            return;
          }

          // Clear textarea: Ctrl/Cmd + K
          if (e.key === 'k') {
            const textarea = document.getElementById('note-input') as HTMLTextAreaElement;
            if (textarea) {
              textarea.value = '';
              textarea.focus();
              e.preventDefault();
            }
            return;
          }
        }
      });

      // Close modal on button click
      document.getElementById('close-shortcuts')?.addEventListener('click', hideShortcutsModal);

      // Close modal on outside click
      document.getElementById('shortcuts-modal')?.addEventListener('click', (e) => {
        if (e.target === e.currentTarget) {
          hideShortcutsModal();
        }
      });

    </script>

    <script>
      // iOS squircle corners implementation
      import CornerKit from '@cornerkit/core';

      document.addEventListener('DOMContentLoaded', () => {
        const ck = new CornerKit();

        // Apply squircle to panels (iOS uses smoothing value of 0.6)
        const panels = document.querySelectorAll('.panel');
        panels.forEach(panel => {
          ck.apply(panel, {
            radius: 16, // 1rem = 16px
            smoothing: 0.6
          });
        });

        // Apply squircle to buttons with slightly tighter radius
        const buttons = document.querySelectorAll('.btn-primary, .btn-secondary');
        buttons.forEach(button => {
          ck.apply(button, {
            radius: 14, // 0.875rem = 14px
            smoothing: 0.6
          });
        });

        // Apply squircle to theme options
        const themeOptions = document.querySelectorAll('.theme-option');
        themeOptions.forEach(option => {
          ck.apply(option, {
            radius: 16,
            smoothing: 0.6
          });
        });

        // Apply squircle to input fields (exclude textareas to avoid border rendering issues)
        const inputs = document.querySelectorAll('.input-field:not(textarea)');
        inputs.forEach(input => {
          ck.apply(input, {
            radius: 12, // 0.75rem = 12px
            smoothing: 0.6
          });
        });
      });
    </script>

    <!-- Mobile Bottom Navigation (PWA) -->
    <nav class="md:hidden fixed bottom-0 left-0 right-0 bg-surface/95 backdrop-blur-md border-t border-default z-40 safe-area-bottom ios-bottom-nav">
      <div class="flex items-center justify-around" style="min-height: var(--touch-target-min);">
        <a
          href="/"
          class={`flex flex-col items-center justify-center flex-1 py-2 transition-colors ${currentPath === '/' ? 'text-accent' : 'text-muted hover:text-primary'}`}
          style="min-height: var(--touch-target-min);"
        >
          <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
          </svg>
          <span class="text-xs mt-0.5">Capture</span>
        </a>
        <a
          href="/browse"
          class={`flex flex-col items-center justify-center flex-1 py-2 transition-colors ${currentPath.startsWith('/browse') ? 'text-accent' : 'text-muted hover:text-primary'}`}
          style="min-height: var(--touch-target-min);"
        >
          <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 7v10a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-6l-2-2H5a2 2 0 00-2 2z" />
          </svg>
          <span class="text-xs mt-0.5">Browse</span>
        </a>
        <a
          href="/dashboard"
          class={`flex flex-col items-center justify-center flex-1 py-2 transition-colors ${currentPath === '/dashboard' ? 'text-accent' : 'text-muted hover:text-primary'}`}
          style="min-height: var(--touch-target-min);"
        >
          <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" />
          </svg>
          <span class="text-xs mt-0.5">Dashboard</span>
        </a>
        <a
          href="/settings"
          class={`flex flex-col items-center justify-center flex-1 py-2 transition-colors ${currentPath === '/settings' ? 'text-accent' : 'text-muted hover:text-primary'}`}
          style="min-height: var(--touch-target-min);"
        >
          <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" />
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
          </svg>
          <span class="text-xs mt-0.5">Settings</span>
        </a>
      </div>
    </nav>

    <style>
      /* iOS safe area support for bottom nav */
      .safe-area-bottom {
        padding-bottom: env(safe-area-inset-bottom);
      }

      /* iOS-style bottom nav shadow */
      .ios-bottom-nav {
        box-shadow: 0 -2px 8px 0 rgb(0 0 0 / 0.08), 0 -1px 2px 0 rgb(0 0 0 / 0.04);
      }
    </style>
  </body>
</html>
